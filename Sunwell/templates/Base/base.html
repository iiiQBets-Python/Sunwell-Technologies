
{% load static %}
<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}--::: ESTDAS :::--{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Sans', 'Nunito', 'Arial', sans-serif;
            height: 100%;
            background-color: #f4f4f4;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .container-fluid {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .container-fluid{
            padding: 0px;
        }
        .sidebar {
            width: 250px;
            height: 100%;
            background: #7ddbef;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            padding: 0px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000; /* Keep sidebar above content */
            transition: transform 0.3s ease; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;  
        }
        /* When sidebar is hidden, translate it off screen */
        .sidebar.hide {
            max-width: 59px;
        }
        .sidebar.hide:hover {
            max-width: 250px;
        }
        .sidebar::-webkit-scrollbar {
            display: none;
        }
        .sidebar-logo {
            padding: 10px 20px;
            align-self: justify;
            height:80px;
            width: 100% ;
        }
        .sidebar.hide .sidebar-logo {
            justify-content: flex-start;
        }
        .sidebar .icon {
            min-width: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 6px;
        }
        .sidebar .icon-right {
            margin-left: auto;
            transition: all 0.3s ease;
        }
        li {
            list-style: none;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar li {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .sidebar a {
            color: #1e5460;
            font-size: 1.1rem;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        /* .sidebar a.active{
            color: #f3411c !important;
        } */
        .sidebar a:hover{
            color:rgb(255, 255, 255);
            
        }
        .sidebar .submenu {
            margin-left: 20px;
            display: none;
        }
        .sidebar .sidebar-menu {
            /* margin: 36px 0; */
            padding: 0 20px;
            transition: all 0.3s ease;
        }
        .sidebar.hide .sidebar-menu {
            padding: 0 6px;
        }
        .sidebar li.active .submenu {
            display: block;    
        }
        .sidebar .submenu a {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .sidebar .submenu a.active {
            color:rgb(255, 255, 255) !important;
            background: #ffffff
            font-weight: bold;
        }
        .main-content {
            position: relative;
            width: calc(100% - 250px);
            left: 250px;
            transition: left 0.3s ease, width 0.3s ease;
        }
        /* When the sidebar is active, adjust main content */
        .sidebar.hide + .main-content {
            width: calc(100% - 59px);
            left: 59px;
        }
        /* Content inside main-content */
        .content {
            transition: margin-left 0.3s ease;
            padding: 20px;
        }
        .top-navbar {
            background: rgb(235, 232, 232);
            color: #141414;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; 
        }
        .navbar-upper, .navbar-lower {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        .navbar-lower {
            background-color: #f8f9fa;
            color: #333;
            justify-content: center;
        }
        .content {
            flex-grow: 1;
            height: 90vh;
            overflow-y: auto; 
            padding: 5px;
        }
        .logo {
            height: 40px;
        }
        .profile-menu {
            position: relative;
            display: inline-block;
        }
        .profile-menu img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }
        .profile-menu-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 5px;
        }
        .profile-menu:hover .profile-menu-content {
            display: block;
        }
        .profile-menu-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .profile-menu-content a:hover {
            background-color: #f1f1f1;
        }
        .profile-sidebar {
            position: fixed;
            right: -300px;
            top: 46px;
            width: 300px;
            height: 60%;
            max-width: 300px;
            max-height: 60%;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 10000;
        }
        .profile-sidebar.open {
            right: 0;
        }
        .profile-header {
            padding: 9px;
            background: rgb(250, 246, 246);
            color: rgb(19, 18, 18);
        }
        .profile-header .close-sidebar {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
        }
        .profile-body {
            padding: 20px;
        }
        .profile-img {
            text-align: center;
            margin-bottom: 20px;
        }
        .profile-img img {
            width: 80px;
            height: 80px;    
        }
        .profile-footer {
            text-align: center;
            padding: 20px;
        }
        .profile-footer .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #dc3545;
            color: white;
            cursor: pointer;
            text-decoration: none;
        }
        .main-content {
            padding: 4px;
        }
        .top-navbar {
            background: rgb(235, 232, 232);
            color: #141414;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 60px; 
            width: 100%; 
        }
        .navbar-upper, .navbar-lower {
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .navbar-upper {
            justify-content: space-between;
            flex-grow: 1;
        }
        .navbar-lower {
            background-color: #f8f9fa;
            color: #333;
            justify-content: flex-start;
            padding-left: 30px;
            height: 20px;
        }
        .navbar-left, .navbar-right {
            display: flex;
            align-items: center;
        }
        .nav-filter .dropdown-toggle {
            margin-right: 10px;
            width: 150px;
            border-radius: 0.375rem;
            border: 1px solid #343434;
            background-color: white;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .nav-filter .dropdown-toggle:hover,
        .nav-filter .dropdown-toggle:focus {
            color: black;
            background-color: #ededed;
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .nav-filter .dropdown-item {
            text-align: center;
            width: 150px;
            color: #141414;
            background-color: #fff;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .nav-filter .dropdown-item:hover {
            background-color: #f1f1f1;
            color: #000000;
        }
        .dropdown-toggle::after {
            display: none;
        }
        .dropdown-toggle {
            border: none;
            background-color: transparent;
        }
        .dropdown-menu {
            min-width: 100px;
        }
        .dropdown-input {
            width: 150px;
            padding: 5px;
            margin: 2px 2px ;
            border-radius: 10px;
            box-sizing: border-box;
        }
        /* Styling for search bar on focus */
        .dropdown-input:focus {
            box-shadow: none;
            border-color: rgb(134, 172, 255);
        }
        .profile-menu img {
            width: 30px;
            height: 30px;
            margin-left: 10px;
            border-radius: 50%;
        }
        #current-date {
            margin-right: 10px;
            font-size: 14px;
        }
        .nav-filter {
            margin-right: 10px; /* Adds space between the two elements */
        }
        .comm-group-display {
            display: inline-block;
            padding: 6px 14px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #ffffff;
            color: #495057;
            font-size: 1rem;
            font-family: inherit;
            text-align: center;
            cursor: default;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.075);
            vertical-align: middle;
            min-width: 100px;
            appearance: none; /* Removes the dropdown icon */
            -moz-appearance: none;
            -webkit-appearance: none;
        }
        .toggle-sidebar {
            margin-right: 10px;
            font-size: 25px;
            cursor: pointer;
        }
        /* Sidebar default behavior */
        .sidebar {
            width: 250px;
            transition: transform 0.3s ease;
            /* transform: translateX(-100%);  */
        }
        /* When the sidebar has the 'active' class, show it */
        .sidebar.active {
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        #change_pass{
            margin-top: 100px;
            z-index: 20000;
        }
        .modal-header{
            background-color: lightgrey;            
        }
        .modal-title{
            font-weight: bold;
        }
        .toggle-sidebar {
            margin-right: 10px;
            font-size: 25px;
            cursor: pointer;
        }
        .toggle-sidebar {
            display: none;
        }
        .highlight {
            color: #036da9 !important; /* Text color */
            background: #ffffff !important;
            /*font-weight: bold;  Optional: make it bold */
            border-left: 0px solid #f3411c; /* Optional: add a left border */
            /* background-color: rgb(254, 254, 254); */
        }

        .password-toggle-icon {
            position: absolute;
            right: 12px; /* Adjust spacing from the right */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #dc3c20; /* Highlight color */
            font-size: 18px;
            z-index: 10; /* Ensure it stays above the input */
        }
        
        

        /* Media Queries for Navbar Responsiveness */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                transform: translateX(-250px); /* Hide sidebar offscreen */
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.active {
                transform: translateX(0); /* Slide in the sidebar when active */
            }
            .main-content {
                width: 100%; /* Ensure main content takes the full width */
                left: 0;
            }
            .toggle-sidebar {
                display: inline-block !important; 
            }
        }
        /* Media Queries for Navbar Responsiveness */
        @media screen and (max-width: 768px) {
            .top-navbar {
                min-height: auto;
                padding: 0;
            }
            .navbar-upper {
                flex-direction: column;
            }
            .navbar-left, .navbar-right {
                /* flex-wrap: wrap; */
                justify-content: space-between;
                padding: 5px;
            }
            .navbar-left, .navbar-right {
                width: 100%;
                justify-content: space-around;
                margin-bottom: 5px;
            }
            .nav-filter .dropdown-toggle {
                width: 100%;
                margin-right: 0;
                /* margin-bottom: 5px; */
            }
            .navbar-lower {
                padding-left: 5px;
                height: auto;
            }
            .sidebar {
                transform: translateX(-250px); /* Hide sidebar offscreen */
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.active {
                transform: translateX(0); /* Slide in the sidebar when active */
            }
            .main-content {
                width: 100%; /* Ensure main content takes the full width */
                left: 0;
            }
            .toggle-sidebar {
                display: inline-block !important;
            }
            .comm-group-display {
                width: 100%;
            }
            
            .nav-filter {
                width: 100%;
                margin-bottom: 5px;
            }
            
        }
    </style>
    <!-- Include CSS Files -->
    {% block styles %}
    {% endblock %}
</head>
<body>
<div class="container-fluid">
    <div class="sidebar" id="sidebar">
        <img src="{% static 'images/Base/Sunwell.png' %}" alt="Your Logo" class="sidebar-logo">
        <ul class="sidebar-menu">
            <li><a href="{% url 'dashboard' %}"><i class="fas fa-home"></i> <b> Dashboard</b></a></li>
            <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-cogs"></i><b> Management</b></a>
                <ul class="submenu" id="management-submenu">
                    {% if data.role == 'Super Admin' or acc_db.org_v %}
                    <li><a href="{% url 'organization' %}"><i class="fas fa-building"></i> <b>Organizations</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.app_v %}
                    <li><a href="{% url 'app_settings' %}"><i class="fas fa-sliders-h"></i> <b>App Settings</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.c_group_v %}
                    <li><a href="{% url 'comm_group' %}"><i class="fas fa-users"></i> <b>Comm. Group</b></a></li>
                    {% endif %}
                    
                    {% if data.role == 'Super Admin' or acc_db.dep_v %}
                    <li><a href="{% url 'department' %}"><i class="fas fa-sitemap"></i> <b>Departments</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.role_v %}
                    <li><a href="{% url 'role_permission' %}"><i class="fas fa-users-cog"></i> <b>Roles & Permissions</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.user_v %}
                    <li><a href="{% url 'users' %}"><i class="fas fa-user-friends"></i> <b>Users</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.back_v %}
                    <li><a href="{% url 'backup' %}"><i class="fas fa-database"></i> <b>Backup</b></a></li>
                    {% endif %}

                    {% comment %} {% if data.role == 'Super Admin' or acc_db.res_v %}
                    <li><a href="{% url 'restore' %}"><i class="fas fa-sync-alt"></i> <b>Restore</b></a></li>
                    {% endif %}

                    {% if data.role == 'Super Admin' or acc_db.sys_v %}
                    <li><a href="#"><i class="fas fa-check-double"></i> <b>System Check</b></a></li>
                    {% endif %} {% endcomment %}
                </ul>
            </li>
            <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-wrench"></i> <b>Equip Settings</b></a>
                <ul class="submenu" id="equip-settings-submenu">
                    {% if data.role == 'Super Admin' or acc_db.e_conf_v %}
                    <li><a href="{% url 'equipment_configure' %}"><i class="fas fa-cog"></i> <b>Equip Config/Settings</b></a></li>
                    {% endif %}
                    {% comment %} <li><a href="#"><i class="fas fa-file-alt"></i> <b>Equipment Documents</b></a></li> {% endcomment %}
                </ul>
            </li>
            <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-chart-line"></i> <b>Data Analysis</b></a>
                <ul class="submenu" id="data-analysis-submenu">
                    {% if data.role == 'Super Admin' or acc_db.v_log_v %}
                    <li><a href="{% url 'view_log' %}"><i class="fas fa-eye"></i> <b>View Logs</b></a></li>
                    {% endif %}
                    {% comment %} <li><a href="#"><i class="fas fa-edit"></i> <b>Manage Logs</b></a></li>
                    <li><a href="#"><i class="fas fa-search-plus"></i> <b>Review/Approve Logs</b></a></li>
                    <li><a href="#"><i class="fas fa-clipboard-check"></i> <b>Reviewed/Approved Logs</b></a></li> {% endcomment %}
                    {% if data.role == 'Super Admin' or acc_db.a_log_v %}
                    <li><a href="{%url 'alaram_log' %}"><i class="fas fa-bell"></i> <b>Alarm Logs</b></a></li>
                    {% endif %}
                    {% if data.role == 'Super Admin' or acc_db.mkt_v %}
                    <li><a href="{%url 'Mkt_analysis' %}"><i class="fas fa-chart-pie"></i> <b>MKT Analysis</b></a></li>
                    {% endif %}
                </ul>
            </li>
            {% comment %} <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-tachometer-alt"></i> <b>Live Data</b></a>
                <ul class="submenu" id="live-data-submenu">
                    <li><a href="{% url 'livedata_summary' %}"><i class="fas fa-list-alt"></i> <b>Summary</b></a></li>
                    <li><a href="#"><i class="fas fa-tv"></i> <b>Display</b></a></li>
                    <li><a href="#"><i class="fas fa-microchip"></i> <b>IO Status</b></a></li>
                    <li><a href="#"><i class="fas fa-hourglass-half"></i> <b>Component Hours</b></a></li>
                </ul>
            </li> {% endcomment %}
            <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-clipboard-list"></i> <b>Audit Logs</b></a>
                <ul class="submenu" id="audit-logs-submenu">
                    {% if data.role == 'Super Admin' or acc_db.u_act_v %}
                    <li><a href="{% url 'user_activity' %}"><i class="fas fa-user-secret"></i> <b>User Activity</b></a></li>
                    {% endif %}
                    {% if data.role == 'Super Admin' or acc_db.u_equ_v %}
                    <li><a href="{% url 'Equipment_Audit_log' %}"><i class="fas fa-desktop"></i> <b>Equipment Activity</b></a></li>
                    {% endif %}
                    {% if data.role == 'Super Admin' or acc_db.a_act_v %}
                    <li><a href="{% url 'alaram_Audit_log' %}"><i class="fas fa-exclamation-triangle"></i> <b>Alarm Activity</b></a></li>
                    {% endif %}
                    {% if data.role == 'Super Admin' or acc_db.e_aud_v %}
                    <li><a href="{% url 'email_Audit_log' %}"><i class="fas fa-envelope"></i> <b>Email Activity</b></a></li>
                    {% endif %}
                    {% if data.role == 'Super Admin' or acc_db.s_act_v %}
                    <li><a href="{% url 'sms_Audit_log' %}"><i class="fas fa-sms"></i> <b>SMS Activity</b></a></li>
                    {% endif %}
                    {% comment %} <li><a href="#"><i class="fas fa-thumbs-up"></i> <b>Reviewed/Approved Activity</b></a></li> {% endcomment %}
                </ul>
            </li>
            {% comment %} <li>
                <a href="#" class="submenu-toggle"><i class="fas fa-archive"></i> <b>Archived Analysis</b></a>
                <ul class="submenu" id="archived-analysis-submenu">
                    <li><a href="#"><i class="fas fa-search"></i> <b>Search Archives</b></a></li>
                    <li><a href="#"><i class="fas fa-redo-alt"></i> <b>Restore</b></a></li>
                    <li><a href="#"><i class="fas fa-chart-bar"></i> <b>Analyze</b></a></li>
                </ul>
            </li> {% endcomment %}

            <li><a href="{% url 'about_us' %}"><i class="fas fa-building"></i> <b> About Us</b></a></li>

            {% comment %} <li><a href="{% url 'upload_csv' %}"><i class="fas fa-file-alt"></i> <b> Upload Csv File</b></a></li> {% endcomment %}
        </ul>
    </div>
    <div class="main-content">
        <div class="top-navbar">
            <div class="navbar-upper">
                <div class="navbar-left">
                    <i class='bx bx-menu toggle-sidebar'></i>
                    <div class="dropdown nav-filter">
                        <span id="commGroupNameDisplay" class="comm-group-display"></span>
                    </div>

                    <div class="dropdown nav-filter">
                        <select class="form-select" id="departmentSelect" onchange="selectDepartment(this.value)">
                            {% for department in data.accessible_departments.all %}
                                <option value="{{ department.id }}" {% if department.id == data.user_department_id %}selected{% endif %}>
                                    {{ department.department_name }}
                                </option>
                            {% empty %}
                                <option disabled>Super Admin</option>
                            {% endfor %}

                        </select>
                    </div>
                </div>
                <div class="navbar-right">
                    <b><div id="current-date"></div></b> 
                    <div class="profile-menu">
                        <img src="{% static 'images/Base/img_avatar.png' %}" onclick="openSidebar('profileSidebar')">
                    </div>
                </div>
            </div>
            <div class="navbar-lower">
                <div><b></b></div>
            </div>
        </div>
        <div class="content">
            {% block content %}{% endblock %}
        </div>
    </div>
</div>

<div class="profile-sidebar" id="profileSidebar">
    <div class="profile-header">
        <span class="close-sidebar" onclick="closeSidebar('profileSidebar')">&times;</span>
        <h5><strong>User Details</strong></h5>
    </div>
    <div class="profile-body">
        <div class="profile-img">
            {% if organization.logo %}
            <img src="{{ organization.logo.url }}" class="img-thumbnail square-img" alt="Company Logo" style="width: 120px; height: 70px;">
            {% else %}
            <img src="{% static 'images/Base/Sunwell_logo.jpg' %}" class="img-thumbnail square-img" alt="Company Logo" style="width: 120px; height: 70px;">
            {% endif %}
        </div>
        <div>
            <p><strong> Username: </strong>{{data.username}}</p>
            <p><strong> Role: </strong>{{data.role}}</p>
            {% if data.role != 'Super Admin' %}
            <a href="#" data-bs-toggle="modal" data-bs-target="#change_pass" style="text-decoration: none;">Change Password</a>
            {% endif %}            
            <div class="modal" id="change_pass" tabindex="-1"  aria-labelledby="change_passLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" style="width: 40%;">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h5 class="modal-title" id="change_passLabel" style="flex: 1; text-align: center; margin: 0;">Change Password</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <form action="" method="post" id="change_pass_form" class="form-control">
                                {% csrf_token %}
                                <div class="mt-1">
                                    <label for="username">Login Name:</label>
                                    <input type="text" name="username" id="username" class="form-control" required>
                                </div>
                                <div class="mt-1 position-relative">
                                    <label for="old_pass">Old Password:</label>
                                    <div class="input-group">
                                        <input type="password" name="old_pass" id="old_pass" class="form-control" required>
                                        <span class="fa fa-fw fa-eye-slash password-toggle-icon" toggle="#old_pass"></span>
                                    </div>
                                </div>
                                
                                <div class="mt-1 position-relative">
                                    <label for="new_pass">New Password:</label>
                                    <div class="input-group">
                                        <input type="password" minlength="8" maxlength="15" name="new_pass" id="new_pass" class="form-control" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Password must be 8-15 characters long and include at least one special character.')">
                                        <span class="fa fa-fw fa-eye-slash password-toggle-icon" toggle="#new_pass"></span>
                                    </div>
                                </div>
                                <div class="mt-2" style="text-align: center;">                                                                        
                                    <a href="#" onclick="handleFileUpload(event)" class="btn btn-sm btn-primary" id="pass_sub" style="width: 100px; display: inline-block;">Submit</a>
                                    <button type="reset" class="btn btn-sm btn-danger" id="clear_btn" style="width: 100px; display: inline-block;">Clear</button>
                                </div>                    
                            </form>            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="profile-footer">
        <a href="{% url 'logout'%}" class="btn">Logout</a>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script>
    function handleFileUpload(event) {
        event.preventDefault(); 
        
        // Use pointerEvents to prevent further interactions
        const submitButton = document.getElementById('pass_sub');
        const clearButton = document.getElementById('clear_btn');
            
        // Disable button interactions
        submitButton.style.pointerEvents = 'none';
        clearButton.style.pointerEvents = 'none';

        // Change cursor to indicate that it's processing
        submitButton.style.cursor = 'not-allowed';
        clearButton.style.cursor = 'not-allowed';

        // Disable the entire screen with a loading overlay
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '9999999';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.innerHTML = '<span style="color: white; font-size: 24px;">Processing...</span>';
        document.body.appendChild(overlay);

        const form = document.getElementById('change_pass_form');
        const formData = new FormData(form);

        fetch("{% url 'change_pass_2' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}' 
            }
        })
        .then(response => response.json())
        .then(data => {
            // Remove the overlay when the response is received
            document.body.removeChild(overlay);

            // Re-enable button interactions and reset cursors
            submitButton.style.pointerEvents = 'auto';
            clearButton.style.pointerEvents = 'auto';
            submitButton.style.cursor = 'pointer';
            clearButton.style.cursor = 'pointer';
            
            if (data.message) {
                if (data.message === 'Please enter valid credentials.') {
                    alert(data.message);
                    form.reset(); // Reset the form 
                } else if (data.message === 'Your password has been changed. Please login again') {
                    alert(data.message);
                    // Redirect to login page
                    window.location.href = "{% url 'login' %}"; 
                } else {
                    alert('Error:' +data.message);
                }
            } else {
                alert('Error: No message received.');
            }
        })
        .catch(error => {
            // Remove the overlay and re-enable buttons in case of error
            document.body.removeChild(overlay);
            submitButton.style.pointerEvents = 'auto';
            clearButton.style.pointerEvents = 'auto';
            submitButton.style.cursor = 'pointer';
            clearButton.style.cursor = 'pointer';

            alert('Error: ' + error.message);
        });
    }
    
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', options);
    
    function openSidebar(id) {
        document.getElementById(id).classList.add('open');
    }
    function closeSidebar(id) {
        document.getElementById(id).classList.remove('open');
    }
    document.querySelectorAll('.sidebar > ul > li').forEach(item => {
        item.addEventListener('click', function() {
            this.classList.toggle('active');
        });
    });
    
    // SIDEBAR js //
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarButton = document.querySelector('.toggle-sidebar');
        const mainContent = document.querySelector('.main-content');
        
        // Function to toggle sidebar visibility
        function toggleSidebar() {
            if (window.innerWidth <= 1024) { // For small screens
                sidebar.classList.toggle('active');
                if (sidebar.classList.contains('active')) {
                    sidebar.style.transform = sidebar.classList.contains('active') ? 'translateX(0)' : 'translateX(-100%)';
                } else {
                    sidebar.style.transform = 'translateX(-100%)';
                }
            } else { // For large screens
                sidebar.classList.toggle('hide');
                mainContent.classList.toggle('shifted');
            }
        }

        // Function to close sidebar on outside click
        function closeSidebarOnOutsideClick(event) {
            if (window.innerWidth <= 1024 && !sidebar.contains(event.target) && !toggleSidebarButton.contains(event.target)) {
                sidebar.classList.remove('active');
                sidebar.style.transform = 'translateX(-100%)';
            }
        }

        // Attach event listeners
        toggleSidebarButton.addEventListener('click', toggleSidebar);
        document.addEventListener('click', closeSidebarOnOutsideClick);

        // Close sidebar when selecting a main menu or submenu item based on conditions
        document.querySelectorAll('.sidebar-menu > li > a').forEach(mainMenuItem => {
            mainMenuItem.addEventListener('click', function (event) {
                const submenu = this.nextElementSibling;
                const isSubmenu = submenu && submenu.classList.contains('submenu');
                
                closeAllSubmenus();
                
                if (!isSubmenu && window.innerWidth <= 1024) {
                    // Close sidebar for main menu items without a submenu
                    sidebar.classList.remove('active');
                    sidebar.style.transform = 'translateX(-100%)';
                }
            });
        });

        // Handle clicks on submenu items
        document.querySelectorAll('.submenu a').forEach(submenuItem => {
            submenuItem.addEventListener('click', function () {
                if (window.innerWidth <= 1024) {
                    // Close sidebar for submenu items
                    sidebar.classList.remove('active');
                    sidebar.style.transform = 'translateX(-100%)';
                }
            });
        });
        
        // Initial sidebar state based on screen size
        function adjustSidebarForScreenSize() {
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('hide');
                sidebar.style.transform = 'translateX(-100%)';
            } else {
                sidebar.classList.remove('active');
                sidebar.style.transform = 'translateX(0)';
            }
        }

        // Adjust sidebar on window resize
        window.addEventListener('resize', adjustSidebarForScreenSize);

        // Initialize sidebar state on page load
        adjustSidebarForScreenSize();
    });
    
    document.addEventListener('DOMContentLoaded', function () {
        // Restore the sidebar state from sessionStorage
        const savedState = sessionStorage.getItem('sidebarState');
        if (savedState) {
            const state = JSON.parse(savedState);
            
            // Restore open submenus
            Object.keys(state).forEach(id => {
                const submenu = document.getElementById(id);
                if (submenu && state[id]) {
                    submenu.style.display = 'block'; // Show the submenu if it was open
                    const toggle = submenu.previousElementSibling;
                    if (toggle) {
                        toggle.classList.add('active'); // Add 'active' to the submenu toggle
                    }
                }
            });
        }
        
        // Handle submenu toggling
        document.querySelectorAll('.submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', function (e) {
                e.preventDefault();

                const submenu = this.nextElementSibling;

                if (submenu && submenu.classList.contains('submenu')) {
                    const isVisible = submenu.style.display === 'block';

                    // Close all other submenus
                    document.querySelectorAll('.submenu').forEach(item => {
                        item.style.display = 'none';
                        if (item.previousElementSibling) {
                            item.previousElementSibling.classList.remove('active');
                        }
                    });

                    // If this submenu was not already visible, open it
                    if (!isVisible) {
                        submenu.style.display = 'block';
                        this.classList.add('active');
                    }

                    // Save the state of all submenus
                    const state = {};
                    document.querySelectorAll('.submenu').forEach(item => {
                        state[item.id] = item.style.display === 'block';
                    });
                    sessionStorage.setItem('sidebarState', JSON.stringify(state));
                }
            });
        });

        // Highlight the active submenu link
        document.querySelectorAll('.submenu a').forEach(link => {
            link.addEventListener('click', function () {
                // Remove 'active' class from all links
                document.querySelectorAll('.submenu a').forEach(item => {
                    item.classList.remove('active');
                });
                // Add 'active' class to the clicked link
                this.classList.add('active');
            });
        });
    });

    document.querySelectorAll('.submenu').forEach(item => {
        item.style.display = 'none';
        if (item.previousElementSibling) {
            item.previousElementSibling.classList.remove('active');
        }
    });


    document.addEventListener('DOMContentLoaded', function () {
        // Highlight the active link (both main menu and submenu) based on the current URL
        const currentUrl = window.location.href;

        // Function to highlight the main menu item and submenu item
        function highlightMenuItems() {
            // Iterate over all links
            document.querySelectorAll('.sidebar a').forEach(link => {
                // Check if the current URL includes the link's href
                if (currentUrl.includes(link.href)) {
                    // Highlight the link
                    link.classList.add('highlight');

                    // If it's a submenu item, highlight its parent main menu item
                    const mainMenuItem = link.closest('.submenu')?.previousElementSibling;
                    if (mainMenuItem) {
                        mainMenuItem.classList.add('highlight');
                    }
                }
            });
        }

        // Function to remove highlight from all menu items
        function removeHighlight() {
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('highlight');
            });
            
        }

        // Attach click event listeners to all links
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function (event) {
                // Remove existing highlights
                removeHighlight();

                // Highlight the clicked link
                this.classList.add('highlight');

                // Highlight the related main menu item (if it's a submenu item)
                const mainMenuItem = this.closest('.submenu')?.previousElementSibling;
                if (mainMenuItem) {
                    mainMenuItem.classList.add('highlight');
                }
            });
        });
        // Highlight menu items on page load
        highlightMenuItems();
    });

    // Map of department IDs to CommGroup names
    const departmentCommGroupMap = {
        {% for department in data.accessible_departments.all %}
            "{{ department.id }}": "{{ department.commGroup.CommGroup_name }}",
        {% endfor %}
    };

    function selectDepartment(departmentId) {
        // Save the selected department ID in localStorage
        localStorage.setItem("selectedDepartmentId", departmentId);

        // Get the CommGroup name based on selected department
        const commGroupName = departmentCommGroupMap[departmentId];
        const commGroupNameDisplay = document.getElementById("commGroupNameDisplay");

        // Set the CommGroup name in the display element
        commGroupNameDisplay.textContent = commGroupName || "N/A";
    }

    // Initialize Department and CommGroup on page load
    document.addEventListener("DOMContentLoaded", function() {
        const departmentSelect = document.getElementById("departmentSelect");
    
        // Check if department is stored in localStorage
        let storedDepartmentId = localStorage.getItem("selectedDepartmentId");
    
        // If no stored department, use the default department from Django
        if (!storedDepartmentId || storedDepartmentId === "null") {
            storedDepartmentId = "{{ data.department.id }}";  // Get default department from Django context
            if (storedDepartmentId) {
                localStorage.setItem("selectedDepartmentId", storedDepartmentId);  // Store it again in localStorage
            }
        }
    
        // Set the dropdown value
        if (storedDepartmentId) {
            departmentSelect.value = storedDepartmentId;
            selectDepartment(storedDepartmentId);  // Update the UI accordingly
        }
    });
    
        

    ///////// Equipment adding and filtering ////////////////////////////////////

    document.addEventListener("DOMContentLoaded", function () {
        const selectedDepartment = localStorage.getItem("selectedDepartmentId");
        const departmentInput = document.getElementById("selectedDepartment");
        if (departmentInput) {
            departmentInput.value = selectedDepartment; // Set the hidden input's value
        }
    });


    document.addEventListener("DOMContentLoaded", function () {
        let timeout;
        const timeoutDuration = {{ timeoutduration }}; 
        function resetTimer() {
            clearTimeout(timeout);
            timeout = setTimeout(logout, timeoutDuration * 60 * 1000); 
        }

        function logout() {
            localStorage.clear(); // Clearing Accessible dept
            window.location.href = "{% url 'logout' %}";
        }

        const events = ['mousemove', 'keydown', 'click', 'scroll'];
        events.forEach(event => {
            window.addEventListener(event, resetTimer);
        });

        resetTimer();
    });


    // Scripts for Communication Offline and Online

    function fetchEquipmentData1() {
        fetch('/get-equipment-data/')
            .then(response => response.json())
            .then(data => {
                const equipmentData = data.equipment_data;
                const allOnline = equipmentData.length > 0 && equipmentData.every(equipment => equipment.status === 'Online');
                updateCommunicationStatus(allOnline); // Pass the status directly to the update function
            })
            .catch(error => {
                console.error('Error fetching equipment data:', error);
                updateCommunicationStatus(false); // Assume offline if there's an error
            });
    }
    
    
    function updateCommunicationStatus(allOnline) {
        const communicationStatusMessage = document.querySelector('.navbar-lower div');
    
        if (allOnline) {
            communicationStatusMessage.innerHTML = '<strong style="color: black;">Communication Online - </strong><strong style="color: #28a745;">All Equipments Active</strong>';;
            communicationStatusMessage.style.color = '#28a745'; 
        } else {
            communicationStatusMessage.innerHTML = '<strong style="color: black;">Communication Offline - </strong><strong style="color: #d20f0f;"> Equipment Communication Error</strong>';
            communicationStatusMessage.style.color = '#d20f0f'; 
        }
    }
    
    
    window.onload = function() {
        fetchEquipmentData1();
        setInterval(fetchEquipmentData, 5000);
    };


    //Password toggle function

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".password-toggle-icon").forEach(icon => {
            icon.addEventListener("click", function () {
                let passwordField = document.getElementById(this.getAttribute("data-target"));
                if (passwordField) {
                    // Toggle password visibility
                    passwordField.type = passwordField.type === "password" ? "text" : "password";
                    
                    // Toggle icon
                    this.classList.toggle("fa-eye");
                    this.classList.toggle("fa-eye-slash");
                }
            });
        });
    });
    
    
    
</script>
    {% block scripts %}
    {% endblock %}
</body>
</html>