


{% load static %}
<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html {
           margin: 0;
           padding: 0;
           font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           height: 100%;
           background-color: #f4f4f4;
       }
       ::-webkit-scrollbar {
           display: none;
       }
       .container-fluid {
           display: flex;
           height: 100vh;
           overflow: hidden;
       }
       .container-fluid{
           padding: 0px;
       }
       .sidebar {
           width: 250px;
           height: auto;
           background: #000d1d;
           padding: 0px;
           box-sizing: border-box;
           box-shadow: 2px 0 5px rgba(0,0,0,0.1);
           display: flex;
           flex-direction: column;
           flex-shrink: 0;
           overflow-y: auto; 
       }
       .sidebar-logo {
           padding: 10px 20px;
           align-self: justify;
           height:80px;
           width: 100% ;
       }
       .sidebar ul {
           list-style-type: none;
           padding: 0;
       }
       .sidebar li {
           margin-bottom: 15px;
           transition: all 0.3s ease;
       }
       .sidebar a {
           color: #ffff;
           text-decoration: none;
           display: block;
           padding: 10px;
           border-radius: 5px;
           transition: all 0.3s ease;
       }
       .sidebar a.active{
           color: #f3411c;
       }
       .sidebar a:hover{
           color: #f3411c;
       }
       .sidebar .submenu {
           margin-left: 20px;
           display: none;
       }
       .sidebar li.active .submenu {
           display: block;
           
       }
       .sidebar .submenu a {
           padding: 5px 10px;
           font-size: 0.9em;
       }

       .sidebar .submenu a.active {
          color: #f3411c;
          font-weight: bold;
       }
       .main-content {
           flex-grow: 1;
           display: flex;
           flex-direction: column;
           height: 100vh;
       }
       .top-navbar {
           background: rgb(235, 232, 232);
           color: #141414;
           box-shadow: 0 2px 5px rgba(0,0,0,0.1);
           flex-shrink: 0; 
       }
       .navbar-upper, .navbar-lower {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 10px 20px;
       }
       .navbar-upper > * {
           margin-left: 20px;
       }
       .navbar-lower {
           background-color: #f8f9fa;
           color: #333;
           justify-content: center;
       }
       .content {
           flex-grow: 1;
           overflow-y: auto; 
           padding: 5px;
       }
       .logo {
           height: 40px;
       }
       .profile-menu {
           position: relative;
           display: inline-block;
       }
       .profile-menu img {
           width: 30px;
           height: 30px;
           border-radius: 50%;
           cursor: pointer;
       }
       .profile-menu-content {
           display: none;
           position: absolute;
           background-color: white;
           min-width: 160px;
           box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
           z-index: 1;
           right: 0;
           border-radius: 5px;
       }
       .profile-menu:hover .profile-menu-content {
           display: block;
       }
       .profile-menu-content a {
           color: black;
           padding: 12px 16px;
           text-decoration: none;
           display: block;
       }
       .profile-menu-content a:hover {
           background-color: #f1f1f1;
       }
       .profile-sidebar {
           position: fixed;
           right: -300px;
           top: 46px;
           width: 300px;
           height: 60%;
           max-width: 300px;
           max-height: 60%;
           background-color: #fff;
           box-shadow: -2px 0 5px rgba(0,0,0,0.1);
           transition: right 0.3s ease;
           z-index: 10000;
       }
       .profile-sidebar.open {
           right: 0;
       }
       .profile-header {
           padding: 9px;
           background: rgb(250, 246, 246);
           color: rgb(19, 18, 18);
       }
       .profile-header .close-sidebar {
           float: right;
           font-size: 1.5em;
           cursor: pointer;
       }
       .profile-body {
           padding: 20px;
       }
       .profile-img {
           text-align: center;
           margin-bottom: 20px;
       }
       .profile-img img {
           width: 80px;
           height: 80px;
           
       }
       .profile-footer {
           text-align: center;
           padding: 20px;
       }
       .profile-footer .btn {
           padding: 10px 20px;
           border: none;
           border-radius: 5px;
           background-color: #dc3545;
           color: white;
           cursor: pointer;
           text-decoration: none;
       }
       .main-content {
           padding: 4px;
       }
       .top-navbar {
          background: rgb(235, 232, 232);
          color: #141414;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          min-height: 60px; 
          width: 100%; 
       }

       .navbar-upper, .navbar-lower {
         display: flex;
         align-items: center;
         padding: 5px 10px;
       }

        .navbar-upper {
        justify-content: space-between;
        flex-grow: 1;
       }

.navbar-lower {
   background-color: #f8f9fa;
   color: #333;
   justify-content: flex-start;
   padding-left: 30px;
   height: 20px;
}

.navbar-left, .navbar-right {
   display: flex;
   align-items: center;
}

.nav-filter .dropdown-toggle {
   margin-right: 10px;
   width: 150px;
   border-radius: 0.375rem;
   border: 1px solid #343434;
   background-color: white;
   transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.nav-filter .dropdown-toggle:hover,
.nav-filter .dropdown-toggle:focus {
   color: black;
   background-color: #ededed;
   border-color: #007bff;
   box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

.nav-filter .dropdown-item {
   text-align: center;
   width: 150px;
   color: #141414;
   background-color: #fff;
   transition: background-color 0.3s ease, color 0.3s ease;
}

.nav-filter .dropdown-item:hover {
   background-color: #f1f1f1;
   color: #000000;
}

.dropdown-toggle::after {
   display: none;
}

.dropdown-toggle {
   border: none;
   background-color: transparent;
}

.dropdown-menu {
   min-width: 100px;
}
.dropdown-input {
   width: 150px;
   padding: 5px;
   margin: 2px 2px ;
   border-radius: 10px;
   box-sizing: border-box;
}

/* Styling for search bar on focus */
.dropdown-input:focus {
   box-shadow: none;
   border-color: rgb(134, 172, 255);
}

.profile-menu img {
   width: 30px;
   height: 30px;
   margin-left: 10px;
   border-radius: 50%;
}

#current-date {
   margin-right: 10px;
   font-size: 14px;
}

.nav-filter {
    margin-right: 10px; /* Adds space between the two elements */
}

.comm-group-display {
    display: inline-block;
    padding: 6px 14px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    background-color: #ffffff;
    color: #495057;
    font-size: 1rem;
    font-family: inherit;
    text-align: center;
    cursor: default;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.075);
    vertical-align: middle;
    min-width: 100px;
    appearance: none; /* Removes the dropdown icon */
    -moz-appearance: none;
    -webkit-appearance: none;
}
/* Media Queries for Navbar Responsiveness */
@media (max-width: 768px) {
       .top-navbar {
           min-height: auto;
       }
       .navbar-upper, .navbar-lower {
           flex-wrap: wrap;
           justify-content: center;
           padding: 5px;
       }
       .navbar-left, .navbar-right {
           width: 100%;
           justify-content: center;
           margin-bottom: 5px;
       }
       .nav-filter .dropdown-toggle {
           width: 100%;
           margin-right: 0;
           margin-bottom: 5px;
       }
       .navbar-lower {
           padding-left: 5px;
           height: auto;
       }
   }

   @media (max-width: 480px) {
       .navbar-upper > * {
           margin-left: 2px;
           margin-right: 2px;
       }
       .profile-menu img {
           width: 25px;
           height: 25px;
       }
       #current-date {
           font-size: 12px;
       }
       .nav-filter .dropdown-toggle,
       .nav-filter .dropdown-item {
           width: 100%;
       }
    }
    #change_pass{
        margin-top: 100px;
        z-index: 20000;
    }
    .modal-header{
        background-color: lightgrey;            
    }
    .modal-title{
        font-weight: bold;
    }

   </style>

    <!-- Include CSS Files -->
    {% block styles %}
    

    {% endblock %}

   
</head>
<body>
    <div class="container-fluid">
        <div class="sidebar">
            <img src="{% static 'images/Base/Sunwell_logo.jpg' %}" alt="Your Logo" class="sidebar-logo">
            <ul class="sidebar-menu">
                <li><a href="{% url 'dashboard' %}"><i class="fas fa-home"></i> <b> Dashboard</b></a></li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-cogs"></i><b> Management</b></a>
                    <ul class="submenu">
                        {% if data.role == 'Super Admin' or acc_db.org_v %}
                        <li><a href="{% url 'organization' %}"><i class="fas fa-building"></i> <b>Organizations</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.c_group_v %}
                        <li><a href="{% url 'comm_group' %}"><i class="fas fa-users"></i> <b>Comm. Group</b></a></li>
                        {% endif %}
                        
                        {% if data.role == 'Super Admin' or acc_db.dep_v %}
                        <li><a href="{% url 'department' %}"><i class="fas fa-sitemap"></i> <b>Departments</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.role_v %}
                        <li><a href="{% url 'role_permission' %}"><i class="fas fa-users-cog"></i> <b>Roles & Permissions</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.user_v %}
                        <li><a href="{% url 'users' %}"><i class="fas fa-user-friends"></i> <b>Users</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.app_v %}
                        <li><a href="{% url 'app_settings' %}"><i class="fas fa-sliders-h"></i> <b>App Settings</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.back_v %}
                        <li><a href="{% url 'backup' %}"><i class="fas fa-database"></i> <b>Backup</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.res_v %}
                        <li><a href="{% url 'restore' %}"><i class="fas fa-sync-alt"></i> <b>Restore</b></a></li>
                        {% endif %}

                        {% if data.role == 'Super Admin' or acc_db.sys_v %}
                        <li><a href="#"><i class="fas fa-check-double"></i> <b>System Check</b></a></li>
                        {% endif %}
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-wrench"></i> <b>Equip Settings</b></a>
                    <ul class="submenu">
                        <li><a href="{% url 'equipment_configure' %}"><i class="fas fa-cog"></i> <b>Equip Config/Settings</b></a></li>
                        <li><a href="#"><i class="fas fa-file-alt"></i> <b>Equipment Documents</b></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-chart-line"></i> <b>Data Analysis</b></a>
                    <ul class="submenu">
                        <li><a href="{% url 'view_log' %}"><i class="fas fa-eye"></i> <b>View Logs</b></a></li>
                        <li><a href="#"><i class="fas fa-edit"></i> <b>Manage Logs</b></a></li>
                        <li><a href="#"><i class="fas fa-search-plus"></i> <b>Review/Approve Logs</b></a></li>
                        <li><a href="#"><i class="fas fa-clipboard-check"></i> <b>Reviewed/Approved Logs</b></a></li>
                        <li><a href="{%url 'alaram_log' %}"><i class="fas fa-bell"></i> <b>Alarm Logs</b></a></li>
                        <li><a href="#"><i class="fas fa-chart-pie"></i> <b>MKT Analysis</b></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-tachometer-alt"></i> <b>Live Data</b></a>
                    <ul class="submenu">
                        <li><a href="{% url 'livedata_summary' %}"><i class="fas fa-list-alt"></i> <b>Summary</b></a></li>
                        <li><a href="#"><i class="fas fa-tv"></i> <b>Display</b></a></li>
                        <li><a href="#"><i class="fas fa-microchip"></i> <b>IO Status</b></a></li>
                        <li><a href="#"><i class="fas fa-hourglass-half"></i> <b>Component Hours</b></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-clipboard-list"></i> <b>Audit Logs</b></a>
                    <ul class="submenu">
                        <li><a href="{% url 'user_activity' %}"><i class="fas fa-user-secret"></i> <b>User Activity</b></a></li>
                        <li><a href="{% url 'Equipment_Audit_log' %}"><i class="fas fa-desktop"></i> <b>Equipment Activity</b></a></li>
                        <li><a href="{% url 'alaram_Audit_log' %}"><i class="fas fa-exclamation-triangle"></i> <b>Alarm Activity</b></a></li>
                        <li><a href="#"><i class="fas fa-envelope"></i> <b>Email/SMS Activity</b></a></li>
                        <li><a href="#"><i class="fas fa-thumbs-up"></i> <b>Reviewed/Approved Activity</b></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-archive"></i> <b>Archived Analysis</b></a>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-search"></i> <b>Search Archives</b></a></li>
                        <li><a href="#"><i class="fas fa-redo-alt"></i> <b>Restore</b></a></li>
                        <li><a href="#"><i class="fas fa-chart-bar"></i> <b>Analyze</b></a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" class="submenu-toggle"><i class="fas fa-building"></i> <b>About Us</b></a>
                    <ul class="submenu">    
                    </ul>
                </li>
                <li><a href="{% url 'upload_csv' %}"><i class="fas fa-file-alt"></i> <b> Upload Csv File</b></a></li>
            </ul>
        </div>
        <div class="main-content">
            <div class="top-navbar">
                <div class="navbar-upper">
                    <div class="navbar-left">
                        <div class="dropdown nav-filter">
                            <span id="commGroupNameDisplay" class="comm-group-display"></span>
                        </div>
                        
                        <div class="dropdown nav-filter">
                            <select class="form-select" id="departmentSelect" onchange="selectDepartment(this.value)">
                                {% for department in data.accessible_departments.all %}
                                    <option value="{{ department.id }}" {% if department.id == data.user_department_id %}selected{% endif %}>
                                        {{ department.department_name }}
                                    </option>
                                {% empty %}
                                    <option disabled>No accessible departments</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                    </div>
                    <div class="navbar-right">
                       <b><div id="current-date"></div></b> 
                        <div class="profile-menu">
                            <img src="{% static 'images/Base/img_avatar.png' %}" onclick="openSidebar('profileSidebar')">
                        </div>
                    </div>
                </div>
                <div class="navbar-lower">
                    <div><b>Communication Offline-Server Service Error/ Data Log Error</b></div>
                </div>
            </div>
            <div class="content">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <div class="profile-sidebar" id="profileSidebar">
        <div class="profile-header">
            <span class="close-sidebar" onclick="closeSidebar('profileSidebar')">&times;</span>
            <h5><strong>User Details</strong></h5>
        </div>
        <div class="profile-body">
            <div class="profile-img">
                {% if organization.logo %}
                    <img src="{{ organization.logo.url }}" class="img-thumbnail square-img" alt="Company Logo" style="width: 120px; height: 70px;">
                {% else %}
                    <img src="{% static 'images/Base/Sunwell_logo.jpg' %}" class="img-thumbnail square-img" alt="Company Logo" style="width: 120px; height: 70px;">
                {% endif %}
            </div>
            <div>
                <p>{{data.username}}</p>
                <p>{{data.role}}</p>

                {% if data.role != 'Super Admin' %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#change_pass" style="text-decoration: none;">Change Password</a>
                {% endif %}            
                <div class="modal" id="change_pass" tabindex="-1"  aria-labelledby="change_passLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg" style="width: 40%;">
                    <div class="modal-content">
                    
                        <!-- Modal Header -->
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h5 class="modal-title" id="change_passLabel" style="flex: 1; text-align: center; margin: 0;">Change Password</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <form action="" method="post" id="change_pass_form" class="form-control">
                                {% csrf_token %}
                                <div class="mt-1">
                                    <label for="username">Login Name:</label>
                                    <input type="text" name="username" id="username" class="form-control" required>
                                </div>
                                <div class="mt-1">
                                    <label for="old_pass">Old Password:</label>
                                    <input type="password" name="old_pass" id="old_pass" class="form-control" required>
                                </div>
                                <div class="mt-1">
                                    <label for="new_pass">New Password:</label>
                                    <input type="password" minlength="8" maxlength="15" name="new_pass" id="new_pass" class="form-control" required>
                                </div>
                                <div class="mt-2" style="text-align: center;">                                                                        
                                    <a href="#" onclick="handleFileUpload(event)" class="btn btn-sm btn-primary" id="pass_sub" style="width: 100px; display: inline-block;">Submit</a>
                                    <button type="reset" class="btn btn-sm btn-danger" id="clear_btn" style="width: 100px; display: inline-block;">Clear</button>
                                </div>                    
                            </form>            
                        </div>
                    </div>
                    </div>
                </div>


            </div>
        </div>
        <div class="profile-footer">
            <a href="{% url 'logout'%}" class="btn">Logout</a>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <script>

        function handleFileUpload(event) {
            event.preventDefault(); 

            // Use pointerEvents to prevent further interactions
            const submitButton = document.getElementById('pass_sub');
            const clearButton = document.getElementById('clear_btn');
            
            // Disable button interactions
            submitButton.style.pointerEvents = 'none';
            clearButton.style.pointerEvents = 'none';

            // Change cursor to indicate that it's processing
            submitButton.style.cursor = 'not-allowed';
            clearButton.style.cursor = 'not-allowed';

            // Disable the entire screen with a loading overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999999';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.innerHTML = '<span style="color: white; font-size: 24px;">Processing...</span>';
            document.body.appendChild(overlay);

            const form = document.getElementById('change_pass_form');
            const formData = new FormData(form);

            fetch("{% url 'change_pass_2' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}' 
                }
            })
            .then(response => response.json())
            .then(data => {
                // Remove the overlay when the response is received
                document.body.removeChild(overlay);

                // Re-enable button interactions and reset cursors
                submitButton.style.pointerEvents = 'auto';
                clearButton.style.pointerEvents = 'auto';
                submitButton.style.cursor = 'pointer';
                clearButton.style.cursor = 'pointer';

                if (data.message) {
                    if (data.message === 'Please enter valid credentials.') {
                        alert(data.message);
                        form.reset(); // Reset the form
                    } else if (data.message === 'Your password has been changed. Please login again') {
                        alert(data.message);
                        // Redirect to login page
                        window.location.href = "{% url 'login' %}"; 
                    } else {
                        alert('Error: Something went wrong.');
                    }
                } else {
                    alert('Error: No message received.');
                }
            })
            .catch(error => {
                // Remove the overlay and re-enable buttons in case of error
                document.body.removeChild(overlay);
                submitButton.style.pointerEvents = 'auto';
                clearButton.style.pointerEvents = 'auto';
                submitButton.style.cursor = 'pointer';
                clearButton.style.cursor = 'pointer';

                alert('Error: ' + error.message);
            });
        }


        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', options);

        function openSidebar(id) {
            document.getElementById(id).classList.add('open');
        }

        function closeSidebar(id) {
            document.getElementById(id).classList.remove('open');
        }

        document.querySelectorAll('.sidebar > ul > li').forEach(item => {
            item.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });

        document.querySelectorAll('.submenu-toggle').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const submenu = this.nextElementSibling;
                if (submenu.style.display === 'block') {
                    submenu.style.display = 'none';
                } else {
                    document.querySelectorAll('.submenu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                    submenu.style.display = 'block';
                }
            });
        });

        document.querySelectorAll('.submenu a').forEach(item => {
            item.addEventListener('click', function(e) {
                document.querySelectorAll('.submenu a').forEach(link => {
                    link.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

////////////////////////////////////

// Map of department IDs to CommGroup names
// Map of department IDs to CommGroup names
const departmentCommGroupMap = {
    {% for department in data.accessible_departments.all %}
        "{{ department.id }}": "{{ department.commGroup.CommGroup_name }}",
    {% endfor %}
};

function selectDepartment(departmentId) {
    // Save the selected department ID in localStorage
    localStorage.setItem("selectedDepartmentId", departmentId);

    // Get the CommGroup name based on selected department
    const commGroupName = departmentCommGroupMap[departmentId];
    const commGroupNameDisplay = document.getElementById("commGroupNameDisplay");

    // Set the CommGroup name in the display element
    commGroupNameDisplay.textContent = commGroupName || "N/A";
}

// Initialize Department and CommGroup on page load
document.addEventListener("DOMContentLoaded", function() {
    const departmentSelect = document.getElementById("departmentSelect");

    // Get the stored department ID from localStorage, if available
    const storedDepartmentId = localStorage.getItem("selectedDepartmentId");

    // Set the stored department ID as selected, if available, otherwise use the default
    if (storedDepartmentId) {
        departmentSelect.value = storedDepartmentId;
        selectDepartment(storedDepartmentId);
    } else {
        // Set default selection if no stored value is found
        selectDepartment(departmentSelect.value);
    }

    // Add event listener for department selection change
    departmentSelect.addEventListener("change", function() {
        selectDepartment(this.value);
    });
});


///////// Equipment adding and filtering ////////////////////////////////////

document.addEventListener("DOMContentLoaded", function () {
    const selectedDepartment = localStorage.getItem("selectedDepartmentId");
    const departmentInput = document.getElementById("selectedDepartment");
    if (departmentInput) {
        departmentInput.value = selectedDepartment; // Set the hidden input's value
    }
});

</script>
    
    {% block scripts %}
    {% endblock %}

</body>
</html>