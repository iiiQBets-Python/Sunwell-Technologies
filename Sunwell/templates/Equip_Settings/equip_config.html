
{% extends "Base/base.html" %}
{% load static %}

{% block title %} equipment_configure {% endblock %}

{% block styles %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/Settings/equipment_config.css' %}">
    <style>
         .floating-alert {
          position: fixed;
          top: -100px; /* Hidden above the view initially */
          right: 40%;
          z-index: 1050;
          width: auto;
          padding: 10px 20px;
          border-radius: 5px;
          background-color: #28a745; /* Green background for success */
          color: white;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          transition: top 0.5s ease-in-out; /* Smooth transition for appearing */
      }

      .floating-alert.show {
          top: 100px; /* Slide down to be visible */
      }
        .icon-size {
            width: 40px; 
            height: 35px; 
            font-size: 16px; 
            vertical-align: middle; 
        }
        .content {
            flex-grow: 1;
            height: 88vh !important;
            overflow-y: auto;
            padding: 5px;
        }
        @media (max-width: 992px) {
            .content {
                height: 89vh !important;
            }
            .table-wrapper {
                overflow-x: auto;
            }
            
            .custom-label {
                /* flex-direction: column !important; */
                align-items: center;
            }
            
            
            .custom-label > div {
                margin-top: 10px;
            }
            
            .d-flex.justify-content-end.align-items-center {
                /* flex-direction: column; */
                align-items: stretch !important;
            }
            
            /* .d-flex.input-group {
                width: 100% !important;
                margin-bottom: 10px;
            } */
            
            .btn-primary {
                width: 100%;
            }
        }
        @media (width: 768px) {
            .d-flex.justify-content-between.align-items-center.mt-3 {
                flex-direction: row; 
                align-items: center !important; 
            }

            .content {
                height: 85vh !important;
            }
        }

        @media (max-width: 767px) {
            .entries-info,
    .pagination {
        justify-content: center !important;
        /* margin-top: 10px; */
    }

    .row.align-items-center > div {
        text-align: center;
    }
            .content {
                height: 75vh !important;
            }
            .entries-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pagination {
                margin-top: 10px;
            }
            
            /* .d-flex.justify-content-between.align-items-center.mt-3 {
                flex-direction: column;
                align-items: stretch !important;
            } */
            
            .d-flex.justify-content-between.align-items-center.mt-3 > div {
                text-align: center;
                margin: 5px 0;
            }
            
            #adminUserModal .modal-dialog {
                max-width: 95%;
                margin: 1.75rem auto;
            }
        }

        @media (max-width: 576px) {
            .custom-label {
                flex-direction: column !important;
                align-items: center;
            }
            .content {
                height: 75vh !important;
            }
            .entries-info, .pagination {
                justify-content: center;
                margin-top: 10px;
            }
            
            #adminUserModal .modal-dialog {
                margin: 0.5rem;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .form-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
{% endblock styles %}

{% block content %}
<div class="container mt-2 table-container fade-in">
    <div 
    id="floating-alert" 
    class="floating-alert" 
    data-show="{% if messages %}{% for message in messages %}{% if 'success' in message.tags %}true{% endif %}{% endfor %}{% endif %}">
    Equipment saved successfully!
</div>

    <div class="d-flex justify-content-end mb-2">
        <div class="dropdown role-filter">
            <button
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                id="roleFilterDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false">
                {{ status_filter|title }} 
            </button>
            <ul class="dropdown-menu" aria-labelledby="roleFilterDropdown">
                <li>
                    <a class="dropdown-item" href="#" data-value="All Status" onclick="filterByStatus('All Status', {{ total_count }})">
                         All {% comment %}<span class="option-count">{{ total_count }}</span> {% endcomment %}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" data-value="Active" onclick="filterByStatus('Active', {{ active_count }})">
                         Active {% comment %}<span class="option-count">{{ active_count }}</span> {% endcomment %}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" data-value="Inactive" onclick="filterByStatus('Inactive', {{ inactive_count }})">
                         Inactive {% comment %}<span class="option-count">{{ inactive_count }}</span> {% endcomment %}
                    </a>
                </li>
            </ul>
        </div>
        
    </div>
    <div class="d-flex justify-content-between align-items-center custom-label mb-2" style="font-weight: bold; padding: 5px 10px; background-color: rgb(235, 235, 235);">
        <section class="d-block custom-label mb-2" style="background-color: rgb(235, 235, 235); text-align: center; font-weight: bold; padding: 5px 0px">
            Equipment Settings <span id="records-info">(Records Found: 0, Selected: 0)</span>
        </section>    
        <div class="d-flex justify-content-end align-items-center">
            <div class="d-flex input-group me-3" style="width: 200px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchBar" class="form-control" placeholder="Search here..">
            </div>
            <div class="d-flex">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adminUserModal"> Add </button> 
            </div>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th scope="col">Equipment Name</th>
                    <th scope="col">IP Address</th>
                    <th scope="col">Status</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody id="form-data-table" class="scrollable-tbody">
                {% for equipment in equipment_list %}
                <tr data-department-id="{{ equipment.department.id }}">
                    <td><input type="checkbox" class="row-checkbox" name="comm_checkbox"></td>
                    <td><a href="{% url 'equipment_setting' equipment.id %}">{{ equipment.equip_name }}</a></td>
                    <td>{{ equipment.ip_address }} </td>
                    <td>{{ equipment.status|title }}</td>
                    <td>
                        <div class="dropdown">
                            <a class="dropdown-item btn-edit" data-id="{{ equipment.id }}" data-is-connected="{{ equipment.is_connected }}" data-bs-toggle="modal" data-bs-target="#editEquipmentModal-{{ equipment.id }}">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                        
                      </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="row align-items-center mt-3 mb-2">
        <!-- Entries Per Page Dropdown -->
        <div class="col-12 col-md-5 justify-content-start align-items-center mb-2 mb-md-0 entries-info">
            <span>Show</span>
            <select id="entriesPerPage" class="form-select d-inline-block mx-2 entriesPerPage">
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <span>entries per page</span>
        </div>
    
        <!-- Showing Entries Info -->
        <div class="col-12 col-md-3 d-flex justify-content-center align-items-center mb-2 mb-md-0">
            <small>Showing <span id="visible-entries">0</span> of <span id="total-entries">0</span> entries</small>
        </div>
    
        <!-- Pagination -->
        <div class="col-12 col-md-4 d-flex justify-content-md-end justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item" id="prev-page"><a class="page-link" href="#">Previous</a></li>
                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item" id="next-page"><a class="page-link" href="#">Next</a></li>
                </ul>
            </nav>
        </div>
    </div> 
</div>

<!-- The Modal -->
<div class="modal fade" id="adminUserModal" tabindex="-1" aria-labelledby="adminUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content container-custom">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title" id="adminUserModalLabel">Equipment Settings</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Modal Body -->
            <div class="modal-body">
                <form method="post" action="{% url 'equipment_configure' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-8 form-group">
                            <input type="text" class="form-control" id="equipname" name="equipname" placeholder=" " required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter Equipment Name')">
                            <label for="equipname" class="form-label">Equipment Name</label>
                        </div>
                        <input type="hidden" id="hiddenFieldName" name="hiddenFieldName" value="{{ data.department.department_name }}">
                        
                        <div class="col-md-4 form-group">
                            <select class="form-control" id="equipStatus" name="equipStatus" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Select the Status')">
                                <option value="" disabled selected>Select Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <label for="equipStatus" class="form-label">Status</label>
                        </div>
                        
                        <div class="col-md-8 form-group">
                            <input type="text" class="form-control ip-address" id="ipaddress" name="ipaddress" placeholder=" " required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter IP Address')">
                            <label for="ipaddress" class="form-label">IP Address</label>
                        </div>
                        <div class="col-md-4 form-group">
                            <i id="plc-connect-btn" class="fa-solid fa-plug-circle-check" style="cursor: pointer;"></i>
                            <i id="plc-disconnect-btn" class="fa-solid fa-plug-circle-xmark" style="display: none; cursor: pointer;"></i>
                        </div>
                        
                        <div class="col-md-12 form-group">
                            <span id="plc-status" class="text-success" style="display:none;">Connected</span>
                            <span id="plc-error" class="text-danger" style="display:none;">Failed to Connect</span>
                        </div>                        

                        <div class="col-md-12 form-group">
                            <select class="form-control" id="interval" name="interval" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter Time Interval')">
                                <option value="" disabled selected>Select an interval</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                            <label for="interval" class="form-label">Interval</label>
                        </div>

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="equiptype" name="equiptype" placeholder=" " required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter equipment Type')">
                            <label for="equiptype" class="form-label">Equipment Type</label>
                        </div>
                        <input type="hidden" name="sensor" id="sensor">
                        <div class="col-md-12 form-group">
                            <select class="form-control" id="door-access-type" name="dooracctype" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Select the Door Access')">
                                <option value="" disabled selected>Select Door Access Type</option>
                                <option value="none">None</option>
                                <option value="plc">PLC</option>
                                <option value="biometric">Biometric</option>
                            </select>
                            <label for="door-access-type" class="form-label">Door Access Type</label>
                        </div>

                        <!-- Dynamic Input Fields -->
                        <div class="row additional-inputs" id="additional-inputs"></div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-outline-success">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{% for equipment in equipment_list %}
<!-- The Modal for Editing Equipment -->
<div class="modal fade" id="editEquipmentModal-{{ equipment.id }}" tabindex="-1" aria-labelledby="editEquipmentModalLabel-{{ equipment.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content container-custom">
            <div class="modal-header">
                <h4 class="modal-title" id="editEquipmentModalLabel-{{ equipment.id }}">Edit Equipment</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'equipment_edit' equipment.id %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-8 form-group">
                            <input type="text" class="form-control" name="edit_equipname" value="{{ equipment.equip_name }}" maxlength="50" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter Equipment Name')">
                            <label for="edit_equipname" class="form-label">Equipment Name</label>
                        </div>
                        <div class="col-md-4 form-group">
                            <select class="form-control" name="edit_equipStatus" required>
                                <option value="active" {% if equipment.status == 'active' %} selected {% endif %}>Active</option>
                                <option value="inactive" {% if equipment.status == 'inactive' %} selected {% endif %}>Inactive</option>
                            </select>
                            <label for="edit_equipStatus" class="form-label">Status</label>
                        </div>
                        <div class="col-md-8 form-group">
                            <input type="text" class="form-control ip-address" name="edit_ipaddress" id="edit_ipaddress_{{ equipment.id }}" value="{{ equipment.ip_address }}" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter IP Address')">
                            <label for="edit_ipaddress" class="form-label">IP Address</label>
                        </div>
                        
                        <div class="col-md-4 form-group">
                            {% if equipment.is_connected %}
                                <i id="plc-connect-btn-{{ equipment.id }}" class="fa-solid fa-plug-circle-check" 
                                   style="cursor: pointer; display: none;"></i>
                                <i id="plc-disconnect-btn-{{ equipment.id }}" class="fa-solid fa-plug-circle-xmark" 
                                   style="cursor: pointer; display: inline;"></i>
                            {% else %}
                                <i id="plc-connect-btn-{{ equipment.id }}" class="fa-solid fa-plug-circle-check" 
                                   style="cursor: pointer; display: inline;"></i>
                                <i id="plc-disconnect-btn-{{ equipment.id }}" class="fa-solid fa-plug-circle-xmark" 
                                   style="cursor: pointer; display: none;"></i>
                            {% endif %}
                        </div>                                                                 
                        <div class="col-md-12 form-group">
                            <span id="edit_plc-status-{{ equipment.id }}" class="text-success" style="display:none;">Connected</span>
                            <span id="edit_plc-error-{{ equipment.id }}" class="text-danger" style="display:none;">Failed to Connect</span>
                        </div>
                        <div class="col-md-12 form-group">
                            <input type="number" class="form-control" name="edit_interval" id="edit_interval_{{ equipment.id }}" value="{{ equipment.interval }}" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter Interval Time')">
                            <label for="edit_interval_{{ equipment.id }}" class="form-label">Interval</label>
                        </div>
                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" name="edit_equiptype" id="edit_equiptype_{{ equipment.id }}" value="{{ equipment.equipment_type }}" required oninput="setCustomValidity('')" oninvalid="setCustomValidity('Please Enter Equipment')">
                            <label for="edit_equiptype_{{ equipment.id }}"  class="form-label">Equipment Type</label>
                        </div>
                        
                        <div class="col-md-12 form-group">
                            <select class="form-control" name="edit_doorAccessType" required>
                                <option value="none" {% if equipment.door_access_type == 'none' %} selected {% endif %}>None</option>
                                <option value="plc" {% if equipment.door_access_type == 'plc' %} selected {% endif %}>PLC</option>
                                <option value="biometric" {% if equipment.door_access_type == 'biometric' %} selected {% endif %}>Biometric</option>
                            </select>
                            <label for="edit_doorAccessType" class="form-label">Door Access Type</label>
                        </div>
                    </div>

                    <!-- Dynamic Inputs for PLC and Biometric Users -->
                    <div id="dynamic-fields-{{ equipment.id }}">
                        {% if plc_users %}
                            <div class="row">
                                {% for user in plc_users %}
                                    <div class="col-md-6 form-group">
                                        <input type="text" class="form-control" name="edit_plc_user_{{ forloop.counter }}" value="{{ user.username }}" placeholder="PLC User {{ forloop.counter }}">
                                        <label for="edit_plc_user_{{ forloop.counter }}" class="form-label">PLC User {{ forloop.counter }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif biometric_users %}
                            <div class="row">
                                {% for user in biometric_users %}
                                    <div class="col-md-6 form-group">
                                        <input type="text" class="form-control" name="edit_biometric_user_{{ forloop.counter }}" value="{{ user.username }}" placeholder="Biometric User {{ forloop.counter }}">
                                        <label for="edit_biometric_user_{{ forloop.counter }}" class="form-label">Biometric User {{ forloop.counter }}</label>
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <input type="text" class="form-control" name="edit_biometric_card_{{ forloop.counter }}" value="{{ user.card_number }}" placeholder="Card Number {{ forloop.counter }}">
                                        <label for="edit_biometric_card_{{ forloop.counter }}" class="form-label">Card Number {{ forloop.counter }}"></label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}



<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        $('#door-access-type').on('change', function() {
            var selectedValue = $(this).val();
            var $additionalInputs = $('#additional-inputs');
            $additionalInputs.empty(); // Clear any existing inputs

            if (selectedValue === 'plc') {
                // Add 15 inputs for "Door Access User"
                for (var i = 1; i <= 15; i++) {
                    $additionalInputs.append(
                        '<div class="col-md-6 form-group">' +
                            '<input type="text" class="form-control" id="plc_user_' + i + '" name="plc_user_' + i + '" placeholder=" ">' +
                            '<label for="plc_user_' + i + '" class="form-label">Door Access User ' + i + '</label>' +
                        '</div>'
                    );
                }
            } else if (selectedValue === 'biometric') {
                // Add fields for Biometric Banner and IP Address
                $additionalInputs.append(
                    '<div class="col-md-12 form-group">' +
                        '<input type="text" class="form-control" id="biometric_banner_text" name="biometric_banner_text" placeholder=" ">' +
                        '<label for="biometric_banner_text" class="form-label">Biometric Banner Text</label>' +
                    '</div>' +
                    '<div class="col-md-12 form-group">' +
                        '<input type="text" class="form-control ip-address" id="biometric_ip_address" name="biometric_ip_address" placeholder=" ">' +
                        '<label for="biometric_ip_address" class="form-label">Biometric IP Address</label>' +
                    '</div>'
                );

                // Add 15 inputs for Biometric User and Card Number
                for (var i = 1; i <= 15; i++) {
                    $additionalInputs.append(
                        '<div class="row mb-3">' +
                            '<div class="col-md-6 form-group">' +
                                '<input type="text" class="form-control" id="biometric_user_' + i + '" name="biometric_user_' + i + '" placeholder=" ">' +
                                '<label for="biometric_user_' + i + '" class="form-label">Biometric User ' + i + '</label>' +
                            '</div>' +
                            '<div class="col-md-6 form-group">' +
                                '<input type="text" class="form-control" id="biometric_card_' + i + '" name="biometric_card_' + i + '" placeholder=" ">' +
                                '<label for="biometric_card_' + i + '" class="form-label">Card Number ' + i + '</label>' +
                            '</div>' +
                        '</div>'
                    );
                }
            }
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
    // Event listener to handle both connect and disconnect clicks
    document.body.addEventListener('click', function (event) {
        const target = event.target.closest('i');

        // Handle connect button click (Add Modal)
        if (target && target.id === 'plc-connect-btn') {
            console.log("Connect button clicked in Add Modal");
            handlePlcConnectForAdd();
        }

        // Handle connect button click (Edit Modal)
        if (target && target.id.startsWith('plc-connect-btn-')) {
            const equipmentId = target.id.split('-').pop();  // Get the equipment ID
            console.log(`Connect button clicked for Equipment ID: ${equipmentId}`);
            handlePlcConnectForEdit(equipmentId);
        }

        // Handle disconnect button click (Add Modal)
        if (target && target.id === 'plc-disconnect-btn') {
            console.log("Disconnect button clicked in Add Modal");
            handlePlcDisconnectForAdd();
        }

        // Handle disconnect button click (Edit Modal)
        if (target && target.id.startsWith('plc-disconnect-btn-')) {
            const equipmentId = target.id.split('-').pop();  // Get the equipment ID
            console.log(`Disconnect button clicked for Equipment ID: ${equipmentId}`);
            handlePlcDisconnectForEdit(equipmentId);
        }
    });

    function handlePlcDisconnectForEdit(equipmentId) {
    const ipAddressInput = document.getElementById(`edit_ipaddress_${equipmentId}`);

    if (!ipAddressInput || !ipAddressInput.value) {
        console.error(`IP address is missing for Equipment ID: ${equipmentId}`);
        return;
    }

    const ipAddress = ipAddressInput.value;

    console.log(`Attempting to disconnect PLC at IP: ${ipAddress} for Equipment ID: ${equipmentId}`);

    disconnectFromPlc(ipAddress).then((response) => {
        if (response.status === 'disconnected') {
            console.log(`PLC Disconnected for Equipment ID: ${equipmentId}`);

            // Update UI to show disconnection status
            document.getElementById(`plc-connect-btn-${equipmentId}`).style.display = 'inline';
            document.getElementById(`plc-disconnect-btn-${equipmentId}`).style.display = 'none';
            document.getElementById(`edit_plc-status-${equipmentId}`).style.display = 'none';
            document.getElementById(`edit_plc-error-${equipmentId}`).style.display = 'none';

            // Optionally, display a success alert
            alert("PLC successfully disconnected!");
        } else {
            console.error(`Failed to disconnect from PLC for Equipment ID: ${equipmentId}`);
        }
    }).catch((error) => {
        console.error(`Error during PLC disconnection for Equipment ID: ${equipmentId}`, error);
    });
}



    // Function to handle PLC connection for Add Modal
    function handlePlcConnectForAdd() {
        const ipAddressInput = document.getElementById('ipaddress');  // Fetch the IP address from Add Modal

        if (!ipAddressInput || !ipAddressInput.value) {
            console.error("IP address is missing!");
            return;
        }

        const ipAddress = ipAddressInput.value;

        console.log(`Attempting to connect to PLC at IP: ${ipAddress} (Add Modal)`);

        connectToPlc(ipAddress).then((response) => {
            if (response.status === 'connected') {
                console.log("PLC Connected (Add Modal)");

                // Update the form fields with values fetched from PLC
                document.getElementById('interval').value = response.interval;
                document.getElementById('sensor').value=response.sensors
                document.getElementById('equiptype').value = response.equiptype;

                // Display success alert
                alert("PLC successfully connected!");

                // Update UI to show connection status
                document.getElementById('plc-connect-btn').style.display = 'none';
                document.getElementById('plc-disconnect-btn').style.display = 'inline';
                document.getElementById('plc-status').style.display = 'inline';
                document.getElementById('plc-error').style.display = 'none';
            } else {
                console.error("Failed to connect to PLC (Add Modal)");
                document.getElementById('plc-error').style.display = 'inline';
                document.getElementById('plc-status').style.display = 'none';
            }
        }).catch((error) => {
            console.error("Error during PLC connection (Add Modal):", error);
            document.getElementById('plc-error').style.display = 'inline';
            document.getElementById('plc-status').style.display = 'none';
        });
    }

    // Function to handle PLC connection for Edit Modal
    function handlePlcConnectForEdit(equipmentId) {
    const ipAddressInput = document.getElementById(`edit_ipaddress_${equipmentId}`);

    if (!ipAddressInput || !ipAddressInput.value) {
        console.error(`IP address is missing for Equipment ID: ${equipmentId}`);
        return;
    }

    const ipAddress = ipAddressInput.value;

    console.log(`Attempting to connect to PLC at IP: ${ipAddress} for Equipment ID: ${equipmentId}`);

    connectToPlc(ipAddress).then((response) => {
        if (response.status === 'connected') {
            console.log(`PLC Connected for Equipment ID: ${equipmentId}`);

            // Update the form fields with values fetched from PLC
            document.getElementById(`edit_interval_${equipmentId}`).value = response.interval;
            document.getElementById('sensor').value=response.sensors
            document.getElementById(`edit_equiptype_${equipmentId}`).value = response.equiptype;

            // Display success alert
            alert("PLC successfully connected!");

            // Update UI to show connection status
            document.getElementById(`plc-connect-btn-${equipmentId}`).style.display = 'none';
            document.getElementById(`plc-disconnect-btn-${equipmentId}`).style.display = 'inline';
            document.getElementById(`edit_plc-status-${equipmentId}`).style.display = 'inline';
            document.getElementById(`edit_plc-error-${equipmentId}`).style.display = 'none';
        } else {
            console.error(`Failed to connect to PLC for Equipment ID: ${equipmentId}`);
            document.getElementById(`edit_plc-error-${equipmentId}`).style.display = 'inline';
            document.getElementById(`edit_plc-status-${equipmentId}`).style.display = 'none';
        }
    }).catch((error) => {
        console.error(`Error during PLC connection for Equipment ID: ${equipmentId}`, error);
        document.getElementById(`edit_plc-error-${equipmentId}`).style.display = 'inline';
        document.getElementById(`edit_plc-status-${equipmentId}`).style.display = 'none';
    });
}



    // Function to connect to PLC
    function connectToPlc(ipAddress) {
        return fetch('/plc_connect/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: new URLSearchParams({ ipaddress: ipAddress }),
        })
        .then(response => response.json())
        .then(data => {
            console.log("PLC connect response:", data);
            // Assuming the PLC response contains interval and equiptype
            return {
                status: data.status,
                interval: data.interval || 5,  // Default interval if not provided
                equiptype: data.equiptype || 'Unknown'  // Default equipment type if not provided
                sensors : data.sensors
            };
        })
        .catch(error => {
            console.error("Error in PLC connect request:", error);
            throw error;
        });
    }

    // Function to handle PLC disconnection for Add Modal
   function handlePlcDisconnectForAdd() {
    const ipAddressInput = document.getElementById('ipaddress');

    if (!ipAddressInput || !ipAddressInput.value) {
        console.error("IP address is missing!");
        return;
    }

    const ipAddress = ipAddressInput.value;

    console.log(`Attempting to disconnect PLC at IP: ${ipAddress} (Add Modal)`);

    disconnectFromPlc(ipAddress).then((response) => {
        if (response.status === 'disconnected') {
            console.log("PLC Disconnected (Add Modal)");

            // Display disconnect alert
            alert("PLC disconnected!");

            // Update UI to show disconnection status
            document.getElementById('plc-connect-btn').style.display = 'inline';
            document.getElementById('plc-disconnect-btn').style.display = 'none';
            document.getElementById('plc-status').style.display = 'none';
            document.getElementById('plc-error').style.display = 'none';
        } else if (response.status === 'already_disconnected') {
            console.log("PLC is already disconnected.");
            alert("PLC was already disconnected.");
        } else {
            console.error("Failed to disconnect from PLC (Add Modal)");
            document.getElementById('plc-error').style.display = 'inline';
        }
    }).catch((error) => {
        console.error("Error during PLC disconnection (Add Modal):", error);
        document.getElementById('plc-error').style.display = 'inline';
    });
}



    // Function to handle PLC disconnection for Edit Modal
    function handlePlcDisconnectForEdit(equipmentId) {
    const ipAddressInput = document.getElementById(`edit_ipaddress_${equipmentId}`);

    if (!ipAddressInput || !ipAddressInput.value) {
        console.error(`IP address is missing for Equipment ID: ${equipmentId}`);
        return;
    }

    const ipAddress = ipAddressInput.value;

    console.log(`Attempting to disconnect PLC at IP: ${ipAddress} for Equipment ID: ${equipmentId}`);

    disconnectFromPlc(ipAddress).then((response) => {
        if (response.status === 'disconnected') {
            console.log(`PLC Disconnected for Equipment ID: ${equipmentId}`);

            // Update UI to show disconnection status
            document.getElementById(`plc-connect-btn-${equipmentId}`).style.display = 'inline';
            document.getElementById(`plc-disconnect-btn-${equipmentId}`).style.display = 'none';
            document.getElementById(`edit_plc-status-${equipmentId}`).style.display = 'none';
            document.getElementById(`edit_plc-error-${equipmentId}`).style.display = 'none';

            // Optionally, display a success alert
            alert("PLC successfully disconnected!");
        } else {
            console.error(`Failed to disconnect from PLC for Equipment ID: ${equipmentId}`);
        }
    }).catch((error) => {
        console.error(`Error during PLC disconnection for Equipment ID: ${equipmentId}`, error);
    });
}


    // Function to stop PLC data reading
    function stopPlcDataReading() {
        console.log("Stopping data reading from PLC...");
        // Logic to stop any background data reading from the PLC
        // Implement your logic to stop the background task/thread for reading data
    }

    // Function to disconnect from PLC
    function disconnectFromPlc(ipAddress) {
        return fetch('/plc_disconnect/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: new URLSearchParams({ ipaddress: ipAddress }),
        })
        .then(response => response.json())
        .then(data => {
            console.log("PLC disconnect response:", data);
            return data;
        })
        .catch(error => {
            console.error("Error in PLC disconnect request:", error);
            throw error;
        });
    }
});



</script>

    {% block scripts %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        function filterByStatus(status, count) {
            const dropdownButton = document.getElementById("roleFilterDropdown");
        
            // Update the button text with the selected status
            dropdownButton.innerHTML = `${status}`;
        
            // Update the URL with the selected status
            const url = new URL(window.location.href); // Create a URL object for the current URL
            url.searchParams.set("status", status === "All Status" ? "all" : status); // Set the 'status' query parameter
            window.location.href = url.toString(); // Reload the page with the updated URL
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Select only fields with the "ip-address" class
            const ipInputs = document.querySelectorAll('.ip-address');

            ipInputs.forEach(function (ipInput) {
                ipInput.addEventListener("input", function () {
                    const value = ipInput.value;
                    // Allow only numbers and dots
                    const sanitizedValue = value.replace(/[^0-9.]/g, "");
                    ipInput.value = sanitizedValue;

                    // Regular expression for a valid IPv4 address
                    const ipPattern = /^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}$/;

                    if (!ipPattern.test(sanitizedValue)) {
                        ipInput.setCustomValidity("Please enter a valid IPv4 address (e.g., 192.168.0.1).");
                    } else {
                        ipInput.setCustomValidity("");
                    }
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            const searchBar = document.getElementById('searchBar');
            const roleFilterDropdown = document.getElementById('roleFilterDropdown');
            const roleFilterItems = document.querySelectorAll('.role-filter .dropdown-item');
            const formDataTable = document.getElementById('form-data-table');
            const tableRows = Array.from(formDataTable.querySelectorAll('tr'));
            const visibleEntries = document.getElementById('visible-entries');
            const totalEntries = document.getElementById('total-entries');
            const pagination = document.querySelector('.pagination');
            const selectAllCheckbox = document.getElementById('selectAll');
            const entriesPerPageSelect = document.getElementById('entriesPerPage');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
        
            let currentPage = 1;
            let entriesPerPage = parseInt(entriesPerPageSelect.value, 10);
            let filteredRows = [];
            let totalEntriesCount = 0;
            let totalPages = 0;
        
            function filterTable() {
                const searchTerm = searchBar.value.toLowerCase().trim();
                const selectedRole = roleFilterDropdown.getAttribute('data-selected-role') || 'all';
        
                filteredRows = tableRows.filter(row => {
                    const cells = Array.from(row.cells);
                    const matchesSearch = cells.some(cell => cell.textContent.toLowerCase().includes(searchTerm));
                    const roleCell = cells[3]; // Status is in the 4th column (index 3)
                    const matchesRole = selectedRole === 'all' || roleCell.textContent.toLowerCase() === selectedRole.toLowerCase();
        
                    return matchesSearch && matchesRole;
                });
        
                totalEntriesCount = filteredRows.length;
                totalPages = Math.ceil(totalEntriesCount / entriesPerPage);
                currentPage = 1;
                updateTable();
                updateRoleCounts(); // Update role counts after filtering
            }
        
            function updateTable() {
                const startIndex = (currentPage - 1) * entriesPerPage;
                const endIndex = startIndex + entriesPerPage;
        
                // Hide all rows
                tableRows.forEach(row => row.style.display = 'none');
        
                // Show only the rows that are part of the current page
                filteredRows.slice(startIndex, endIndex).forEach(row => row.style.display = '');
        
                visibleEntries.textContent = filteredRows.slice(startIndex, endIndex).length;
                totalEntries.textContent = totalEntriesCount;
        
                updatePagination();
            }
        
            function updatePagination() {
                const pageItems = Array.from(pagination.querySelectorAll('.page-item:not(#prev-page):not(#next-page)'));
                pageItems.forEach(item => item.remove());
        
                prevPageButton.classList.toggle('disabled', currentPage === 1);
                nextPageButton.classList.toggle('disabled', currentPage === totalPages);
        
                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pageItem.addEventListener('click', (event) => {
                        event.preventDefault();
                        currentPage = i;
                        updateTable();
                    });
                    pagination.insertBefore(pageItem, nextPageButton);
                }
            }
        
            function getSelectedRowsCount() {
                return formDataTable.querySelectorAll('input[type="checkbox"]:checked:not(#selectAll)').length;
            }
        
            function updateRecordsInfo() {
                document.getElementById('records-info').textContent = `(Records Found: ${totalEntriesCount}, Selected: ${getSelectedRowsCount()})`;
            }
        
            function updateRoleCounts() {
                roleFilterItems.forEach(item => {
                    const role = item.getAttribute('data-value').toLowerCase();
                    let roleCount = 0;
        
                    // Count rows that match the role
                    tableRows.forEach(row => {
                        const statusCell = row.cells[3]; // Assuming status is in the 4th column (index 3)
                        const rowStatus = statusCell.textContent.toLowerCase();
        
                        if (role === 'all' || rowStatus === role) {
                            roleCount++;
                        }
                    });
        
                    // Update the count in the dropdown
                    item.querySelector('.option-count').textContent = `${roleCount}`;
                });
            }
        
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = formDataTable.querySelectorAll('input[type="checkbox"]:not(#selectAll)');
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                updateRecordsInfo();
            });
        
            formDataTable.addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target !== selectAllCheckbox) {
                    selectAllCheckbox.checked = Array.from(formDataTable.querySelectorAll('input[type="checkbox"]:not(#selectAll)')).every(checkbox => checkbox.checked);
                    updateRecordsInfo();
                }
            });
        
            searchBar.addEventListener('input', function() {
                filterTable();
                updateRecordsInfo();
            });
        
            roleFilterItems.forEach(item => {
                item.addEventListener('click', function () {
                    roleFilterDropdown.setAttribute('data-selected-role', item.getAttribute('data-value'));
                    roleFilterDropdown.textContent = item.textContent;
                    filterTable();
                    updateRecordsInfo();
                });
            });
        
            entriesPerPageSelect.addEventListener('change', function() {
                entriesPerPage = parseInt(this.value, 10);
                totalPages = Math.ceil(totalEntriesCount / entriesPerPage);
                currentPage = 1;
                updateTable();
            });
        
            prevPageButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                }
            });
        
            nextPageButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                }
            });
        
            document.querySelectorAll('.role-filter .dropdown-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const selectedText = this.innerHTML;
                    document.getElementById('roleFilterDropdown').innerHTML = selectedText;
                });
            });
        
            filterTable(); 
            updateRecordsInfo(); 
        });

        const plcUsers = JSON.parse('{{ plc_users|safe }}');
        const biometricUsers = JSON.parse('{{ biometric_users|safe }}');

        document.addEventListener("DOMContentLoaded", function() {
            const doorAccessTypeField = document.querySelector("select[name='edit_doorAccessType']");
            
            if (doorAccessTypeField) {
                doorAccessTypeField.addEventListener("change", function() {
                    const selectedValue = this.value;
                    const additionalInputs = document.querySelector('#dynamic-fields-{{ equipment.id }}');
                    additionalInputs.innerHTML = "";  // Clear existing inputs

                    if (selectedValue === 'plc') {
                        plcUsers.forEach(function(user, index) {
                            additionalInputs.insertAdjacentHTML('beforeend', `
                                <div class="col-md-6 form-group">
                                    <input type="text" class="form-control" id="edit_plc_user_${index + 1}" name="edit_plc_user_${index + 1}" value="${user.username}" placeholder="PLC User ${index + 1}">
                                    <label for="edit_plc_user_${index + 1}" class="form-label">PLC User ${index + 1}</label>
                                </div>
                            `);
                        });
                    } else if (selectedValue === 'biometric') {
                        biometricUsers.forEach(function(user, index) {
                            additionalInputs.insertAdjacentHTML('beforeend', `
                                <div class="col-md-6 form-group">
                                    <input type="text" class="form-control" id="edit_biometric_user_${index + 1}" name="edit_biometric_user_${index + 1}" value="${user.username}" placeholder="Biometric User ${index + 1}">
                                    <label for="edit_biometric_user_${index + 1}" class="form-label">Biometric User ${index + 1}</label>
                                </div>
                                <div class="col-md-6 form-group">
                                    <input type="text" class="form-control" id="edit_biometric_card_${index + 1}" name="edit_biometric_card_${index + 1}" value="${user.card_number}" placeholder="Card Number ${index + 1}">
                                    <label for="edit_biometric_card_${index + 1}" class="form-label">Card Number ${index + 1}</label>
                                </div>
                            `);
                        });
                    }
                });

              
                doorAccessTypeField.dispatchEvent(new Event("change"));
            }
        });
        
        document.getElementById('adminUserModal').addEventListener('hidden.bs.modal', function (e) {
            var form = document.getElementById('adminUserForm');
            form.reset();
            document.getElementById('selectedDepartments').innerHTML = ''; 
            const inputs = document.querySelectorAll(".form-control, .form-select");
            inputs.forEach(input => input.classList.remove("filled"));
        });

       

    
    </script>
    <script>
        function showFloatingAlert() {
            var alertElement = document.getElementById('floating-alert');
            alertElement.classList.add('show'); 
            setTimeout(function() {
                alertElement.classList.remove('show'); 
            }, 2000);
        }
    
       
        window.onload = function() {
            const floatingAlert = document.getElementById('floating-alert');
            if (floatingAlert && floatingAlert.dataset.show === "true") {
                showFloatingAlert();
            }
        }
    
    </script><script>
        document.addEventListener('DOMContentLoaded', function () {
    const departmentName = document.getElementById('hiddenFieldName').value; 
    const rows = document.querySelectorAll('#form-data-table tr');

    
    if (departmentName.toLowerCase() === 'admin') {
        rows.forEach(row => {
            row.style.display = ''; 
        });
        return; 
    }

    
    let hasEquipment = false; 
    rows.forEach(row => {
        const rowDepartment = row.getAttribute('data-department'); 
        if (rowDepartment === departmentName) {
            row.style.display = ''; 
            hasEquipment = true; 
        } else {
            row.style.display = 'none'; 
        }
    });
    
});


///////// Filtering user values from nav bar accessible departments ////////////
  
document.addEventListener("DOMContentLoaded", function() {
    const departmentSelect = document.getElementById("departmentSelect");

    // Retrieve the selected department ID from localStorage; default to "all" if not set
    let selectedDepartmentId = localStorage.getItem("selectedDepartmentId") || "all";

    console.log("selected Department", selectedDepartmentId)

    // Set the dropdown to the saved value
    if (departmentSelect) {
        departmentSelect.value = selectedDepartmentId;
    }

    // Function to filter equipment based on selected department
    function filterEquipmentByDepartment(departmentId) {
        const rows = document.querySelectorAll("#form-data-table tr");

        let visibleRowsCount = 0;

        rows.forEach(row => {
            const rowDepartmentId = row.getAttribute("data-department-id");
            if (departmentId === "all" || rowDepartmentId === departmentId) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        // Update the records info based on visible rows
        document.getElementById("records-info").textContent = `(Records Found: ${visibleRowsCount}, Selected: 0)`;
    }

    // Apply the filter based on the selected department ID from localStorage
    filterEquipmentByDepartment(selectedDepartmentId);

    // Event listener for department selection change
    if (departmentSelect) {
        departmentSelect.addEventListener("change", function() {
            selectedDepartmentId = this.value;
            localStorage.setItem("selectedDepartmentId", selectedDepartmentId); // Save selection in localStorage
            filterEquipmentByDepartment(selectedDepartmentId); // Apply filter
        });
    }
});



</script>


    
    {% endblock %}
{% endblock content %}