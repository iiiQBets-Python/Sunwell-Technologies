{% extends "Base/base.html" %}
{% load static %}

{% block title %} --::: ESTDAS :::-- {% endblock %}

{% block styles %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/Settings/graphcolor.css' %}">
    <style>
        .content {
            flex-grow: 1;
            height: 85vh !important;
            overflow-y: auto;
            padding: 5px;
        }
         .container {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .section-title {
            font-weight: bold;
            margin-top: 20px;
        }
        .nav-tabs .nav-item {
            margin-bottom: -1px;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none;
        }

        /* Ensure the dropdown menu background remains default */
        .custom-select option {
            background-color: white;
            color: black;
        }
        
        /* Custom style for the selected item */
        .color-select{
            cursor: pointer;
        }
        .checkbox-list-1, .checkbox-list-2 {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }
        .form-check {
            margin-bottom: 10px;
        }
        .nav-tabs {
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            display: block; /* Default for small screens */
        }

        @media (min-width: 768px) {
            /* Apply display: flex for medium and larger screens */
            .tabs {
                display: flex;
            }
        }
        @media (max-width: 992px) {
            .container{
                max-width: 100% !important;
            }
            .content {
                height: 89vh !important;
            }
            .table-wrapper {
                overflow-x: auto;
            }
            
            .custom-label {
                /* flex-direction: column !important; */
                align-items: center;
            }
            
            
            .custom-label > div {
                margin-top: 10px;
            }
            
            .d-flex.justify-content-end.align-items-center {
                /* flex-direction: column; */
                align-items: stretch !important;
            }
            
            /* .d-flex.input-group {
                width: 100% !important;
                margin-bottom: 10px;
            } */
            
            /* .btn-primary {
                width: 100%;
            } */
        }
        @media (width: 768px) {
            .d-flex.justify-content-between.align-items-center.mt-3 {
                flex-direction: row; 
                align-items: center !important; 
            }

            .content {
                height: 85vh !important;
            }
            .container{
                max-width: 100% !important;
            }
        }

        @media (max-width: 767px) {
            .entries-info,
    .pagination {
        justify-content: center !important;
        /* margin-top: 10px; */
    }

    .row.align-items-center > div {
        text-align: center;
    }
            .content {
                height: 75vh !important;
            }
            .entries-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pagination {
                margin-top: 10px;
            }
            
            /* .d-flex.justify-content-between.align-items-center.mt-3 {
                flex-direction: column;
                align-items: stretch !important;
            } */
            
            .d-flex.justify-content-between.align-items-center.mt-3 > div {
                text-align: center;
                margin: 5px 0;
            }
            
            #adminUserModal .modal-dialog {
                max-width: 95%;
                margin: 1.75rem auto;
            }
        }

        @media (max-width: 576px) {
            .custom-label {
                flex-direction: column !important;
                align-items: center;
            }
            .content {
                height: 75vh !important;
            }
            .entries-info, .pagination {
                justify-content: center;
                margin-top: 10px;
            }
            
            #adminUserModal .modal-dialog {
                margin: 0.5rem;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .form-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
        }
        
        /* Floating Label Styles Specific to Modal */
        #authModal .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        #authModal .form-label {
            position: absolute;
            top: 50%;
            left: 25px;
            transform: translateY(-50%);
            background: #fff;
            padding: 0 5px;
            color: #aaa;
            transition: 0.2s ease all;
            pointer-events: none;
        }

        #authModal .form-control:focus,
        #authModal .form-control.filled {
            border-color: #007bff;
            box-shadow: none;
        }


        #authModal .form-control:focus ~ .form-label,
        #authModal .form-control:not(:placeholder-shown) ~ .form-label {
            top: 0;
            transform: translateY(-60%);
            left: 18px;
            font-size: 14px;
            color: #007bff;
        }

        #authModal .form-control.filled ~ .form-label,
        #authModal .form-control:not(:placeholder-shown) ~ .form-label {
            color: black; /* Initially black */
        }

        #authModal .form-control:focus ~ .form-label,
        #authModal .form-control:focus.filled ~ .form-label {
            color: #007bff;
            font-weight: bold;
        }

        .edit-save-buttons {
            position: sticky; /* Stick to the top of the tab content */
            top: 0; /* Adjust based on where you want it to stick */
            z-index: 1000; /* Ensure it appears above other elements */
            background-color: white; /* Match the background of your content */
            /* padding: 10px; */
            /* border-bottom: 1px solid #dee2e6;  */
        }

    </style>
{% endblock styles %}

{% block content %} 
<div class="container mt-2 equipment-setting">
    <h3 class="mb-2">Equipment Setting</h3>
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="equipmentName" class="form-label">Equipment Name</label>
            <input type="text" class="form-control" id="equipmentName" value="{{ equipment.equip_name }}">
        </div>
        <div class="col-md-3">
            <label for="ipAddress" class="form-label">IP Address</label>
            <div class="d-flex">
                <input type="text" class="form-control me-2" id="ip_address" value="{{ equipment.ip_address }}">
            </div>
        </div>
        <div class="col-md-3">
            <label for="status" class="form-label">Status</label>
            <select name="status" id="status" class="form-select" readonly>
                <option value="online" {% if equipment.status == "Yes" %}selected{% endif %}>Online</option>
                <option value="offline" {% if equipment.status != "Yes" %}selected{% endif %}>Offline</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="loginInterval" class="form-label">Login Interval</label>
            <div class="d-flex align-items-center">
                <input type="number" class="form-control me-2" id="loginInterval" value="{{ equipment.interval }}" min="1" max="480">
                <span style="white-space: nowrap;">mins (Max 480)</span>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <div class="tabs">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="parameters-tab" data-bs-toggle="tab" data-bs-target="#parameters" type="button" role="tab" aria-controls="parameters" aria-selected="true">Equipment Parameters</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Equipment Settings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="write-event-tab" data-bs-toggle="tab" data-bs-target="#write-event" type="button" role="tab" aria-controls="write-event" aria-selected="false">Equipment Write Event</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="email-sms-alarm-alert-tab" data-bs-toggle="tab" data-bs-target="#emailsmsalert" type="button" role="tab" aria-controls="emailsmsalert" aria-selected="false">Email/SMS Alarm Alert</button>
            </li>
        </div>
        <!-- <div class="d-flex justify-content-end align-items-end"> 
            <button class="btn btn-primary edit-button me-2" onclick="editMode(this)">Edit</button>
            <button class="btn btn-success save-button d-none" onclick="saveMode(this)">Save</button>
        </div> -->
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active table-container" id="parameters" role="tabpanel" aria-labelledby="parameters-tab" style="padding:15px; background:#ffff;">
            <div class="d-flex justify-content-end align-items-end">
                {% if data.role == 'Super Admin' or acc_db.e_set_e %} 
                <button class="btn btn-primary edit-button me-2 mb-2" onclick="editMode(this)">Edit</button>
                {% endif %}
                <button class="btn btn-success save-button me-2 mb-2 d-none" onclick="saveMode(this)">Save</button>
            </div>
            <div class="table-wrapper">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th scope="col">Name (Temp in °C and RH in %)</th>
                            <th scope="col">Graph Color</th>
                        </tr>
                    </thead>
                    <tbody id="form-data-table">
                        {% for temp in temperature_settings %}
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>Temperature {{ temp.index }}</td>
                            <td>
                                <select class="form-select color-select" name="t{{ temp.index }}color"  disabled>
                                    <option value=""  {% if not temp.color %}selected{% endif %}disabled selected>Select Color</option>
                                    <option value="black" {% if temp.color == "black" %}selected{% endif %}>Black</option>
                                    <option value="darkred"{% if temp.color == "darkred" %}selected{% endif %}>DarkRed</option>
                                    <option value="midnightblue"{% if temp.color == "midnightblue" %}selected{% endif %}>MidnightBlue</option>
                                    <option value="darksalmon"{% if temp.color == "darksalmon" %}selected{% endif %}>DarkSalmon</option>
                                    <option value="olive"{% if temp.color == "olive" %}selected{% endif %}>Olive</option>
                                    <option value="darkslateblue"{% if temp.color == "darkslateblue" %}selected{% endif %}>DarkSlateBlue</option>
                                    <option value="orange"{% if temp.color == "orange" %}selected{% endif %}>Orange</option>
                                    <option value="darkorange"{% if temp.color == "darkorange" %}selected{% endif %}>DarkOrange</option>
                                    <option value="green"{% if temp.color == "green" %}selected{% endif %}>Green</option>
                                    <option value="blue"{% if temp.color == "blue" %}selected{% endif %}>Blue</option>
                                    <option value="red"{% if temp.color == "red" %}selected{% endif %}>Red</option>
                                    <option value="cyan"{% if temp.color == "cyan" %}selected{% endif %}>Cyan</option>
                                    <option value="magenta"{% if temp.color == "magenta" %}selected{% endif %}>Magenta</option>
                                    <option value="yellow"{% if temp.color == "yellow" %}selected{% endif %}>Yellow</option>
                                    <option value="lightgreen"{% if temp.color == "lightgreen" %}selected{% endif %}>Light Green</option>
                                    <option value="lightblue"{% if temp.color == "lightblue" %}selected{% endif %}>Light Blue</option>
                                    <option value="violet"{% if temp.color == "violet" %}selected{% endif %}>Violet</option>
                                    <option value="purple"{% if temp.color == "purple" %}selected{% endif %}>Purple</option>
                                    <option value="navy"{% if temp.color == "navy" %}selected{% endif %}>Navy</option>
                                    <option value="grey"{% if temp.color == "grey" %}selected{% endif %}>Grey</option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                      
                        {% if show_humidity %}
                        {% for hum in humidity_settings %}
                        <tr>
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td>Humidity {{ hum.index }}</td>
                            <td>
                                <select class="form-select color-select" name="t{{ temp.index }}color"  disabled>
                                    <option value=""  {% if not hum.color %}selected{% endif %}disabled selected>Select Color</option>
                                    <option value="black" {% if hum.color == "black" %}selected{% endif %}>Black</option>
                                    <option value="darkred"{% if hum.color == "darkred" %}selected{% endif %}>DarkRed</option>
                                    <option value="midnightblue"{% if hum.color == "midnightblue" %}selected{% endif %}>MidnightBlue</option>
                                    <option value="darksalmon"{% if hum.color == "darksalmon" %}selected{% endif %}>DarkSalmon</option>
                                    <option value="olive"{% if hum.color == "olive" %}selected{% endif %}>Olive</option>
                                    <option value="darkslateblue"{% if  hum.color == "darkslateblue" %}selected{% endif %}>DarkSlateBlue</option>
                                    <option value="orange"{% if hum.color == "orange" %}selected{% endif %}>Orange</option>
                                    <option value="darkorange"{% if hum.color == "darkorange" %}selected{% endif %}>DarkOrange</option>
                                    <option value="green"{% if hum.color == "green" %}selected{% endif %}>Green</option>
                                    <option value="blue"{% if hum.color == "blue" %}selected{% endif %}>Blue</option>
                                    <option value="red"{% if hum.color == "red" %}selected{% endif %}>Red</option>
                                    <option value="cyan"{% if hum.color == "cyan" %}selected{% endif %}>Cyan</option>
                                    <option value="magenta"{% if hum.color == "magenta" %}selected{% endif %}>Magenta</option>
                                    <option value="yellow"{% if hum.color == "yellow" %}selected{% endif %}>Yellow</option>
                                    <option value="lightgreen"{% if hum.color == "lightgreen" %}selected{% endif %}>Light Green</option>
                                    <option value="lightblue"{% if hum.color == "lightblue" %}selected{% endif %}>Light Blue</option>
                                    <option value="violet"{% if hum.color == "violet" %}selected{% endif %}>Violet</option>
                                    <option value="purple"{% if hum.color == "purple" %}selected{% endif %}>Purple</option>
                                    <option value="navy"{% if hum.color == "navy" %}selected{% endif %}>Navy</option>
                                    <option value="grey"{% if hum.color == "grey" %}selected{% endif %}>Grey</option>
                                </select>
                            </td>
                        </tr>
                       {% endfor %}
                       {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- <div class="row align-items-center mt-3 mb-2">
                <div class="col-12 col-md-5 justify-content-start align-items-center mb-2 mb-md-0 entries-info">
                    <span>Show</span>
                    <select id="entriesPerPage" class="form-select d-inline-block mx-2 entriesPerPage">
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>entries per page</span>
                </div>
            
                <div class="col-12 col-md-3 d-flex justify-content-center align-items-center mb-2 mb-md-0">
                    <small>Showing <span id="visible-entries">0</span> of <span id="total-entries">0</span> entries</small>
                </div>
            
                <div class="col-12 col-md-4 d-flex justify-content-md-end justify-content-center">
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            <li class="page-item" id="prev-page"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item" id="next-page"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>  -->
        </div>


        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab" style="padding:15px; background:#ffff;">
            <div class="settings-wrapper fade show active" id="equipment-parameters" role="tabpanel" aria-labelledby="equipment-parameters-tab">
                <div class="edit-save-buttons d-flex justify-content-end align-items-end"> 
                    {% if data.role == 'Super Admin' or acc_db.e_set_e %} 
                    <button class="btn btn-primary edit-button me-2" onclick="editMode(this)">Edit</button>
                    {% endif %}
                    <button class="btn btn-success save-button d-none" onclick="saveMode(this)">Save</button>
                </div>
                <h5 class="section-title">Temperature</h5>
                <div class="row">
                    <!-- First Column -->
                    <div class="col-md-4">
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Set Value</label>
                            <div class="col-sm-7">
                                <input type="number" class="form-control" name="temp_set_value" step="0.01" value="{{ equipment.set_value|floatformat:2 }}">
                            </div>
                            
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Low Alarm</label>
                            <div class="col-sm-7">
                                <input type="number" class="form-control" name="temp_low_alarm" step="0.01" value="{{ equipment.low_alarm|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">High Alarm</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" name="temp_high_alarm" step="0.01" value="{{ equipment.high_alarm|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Total Sensor</label>
                            <div class="col-sm-7">
                                <input type="number" class="form-control" name="temp_sensor"  value="{{ equipment.total_temp_sensors }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Column -->
                    <div class="col-md-4">
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">High Alert</label>
                            <div class="col-sm-7">
                                <input type="number" name="temp_high_alert" class="form-control" step="0.01" value="{{ equipment.high_alert|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Low Alert</label>
                            <div class="col-sm-7">
                                <input type="number" name="temp_low_alert" class="form-control" step="0.01" value="{{ equipment.low_alert|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Cooling</label>
                            <div class="col-sm-7">
                                <select class="form-select">
                                    <option>Yes</option>
                                    <option>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                {% if show_humidity %}
                <h5 class="section-title">Humidity</h5>
                <div class="row">
                    <!-- First Column -->
                    <div class="col-md-4">
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Set Value</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_set_value" step="0.01" class="form-control" value="{{ equipment.set_value_hum|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Low Alarm</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_low_alarm" step="0.01" class="form-control"value="{{ equipment.low_alarm_hum|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">High Alarm</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_high_alarm" step="0.01" class="form-control" value="{{ equipment.high_alarm_hum|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Total Sensor</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_sensor" class="form-control" value="{{ equipment.total_humidity_sensors }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Column -->
                    <div class="col-md-4">
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">High Alert</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_high_alert" step="0.01" class="form-control" value="{{ equipment.high_alert_hum|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Low Alert</label>
                            <div class="col-sm-7">
                                <input type="number" name="humidity_low_alert" step="0.01" class="form-control" value="{{ equipment.low_alert_hum|floatformat:2 }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label">Cooling</label>
                            <div class="col-sm-7">
                                <select class="form-select">
                                    <option>Yes</option>
                                    <option>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                   
                </div>
                {% endif %}
                
            </div>
        </div>
       

        <div class="tab-pane fade" id="write-event" role="tabpanel" aria-labelledby="write-event-tab">
            <div class="table-wrapper">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th scope="col">Equipment Name</th>
                            <th scope="col">Write Date</th>
                            <th scope="col">Write Time</th>
                            <th scope="col">Parameter Label</th>
                            <th scope="col">Parameter Value</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody id="write-event_form-data-table" class="scrollable-tbody">
                        {% if equipmentwrite %}
                            {% for entry in equipmentwrite %}
                            <tr>
                                <td><input type="checkbox" class="row-checkbox"></td>
                                <td>{{ entry.equipment.equip_name }}</td>
                                <td>{{ entry.date|date:"d-m-Y" }}</td>
                                <td>{{ entry.time|time:"H:i" }}</td>
                                <td>{{ entry.label }}</td>
                                <td>{{ entry.value }}</td>
                                <td></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7">No entries found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                    
                </table>
            </div>
            <!-- <div class="row align-items-center mt-3 mb-2">
                <div class="col-12 col-md-5 justify-content-start align-items-center mb-2 mb-md-0 entries-info">
                    <span>Show</span>
                    <select id="entriesPerPage" class="form-select d-inline-block mx-2 entriesPerPage">
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>entries per page</span>
                </div>
            
                <div class="col-12 col-md-3 d-flex justify-content-center align-items-center mb-2 mb-md-0">
                    <small>Showing <span id="visible-entries">0</span> of <span id="total-entries">0</span> entries</small>
                </div>
            
                <div class="col-12 col-md-4 d-flex justify-content-md-end justify-content-center">
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            <li class="page-item" id="prev-page"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item" id="next-page"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>   -->
        </div>

        <div class="tab-pane fade" id="emailsmsalert" role="tabpanel" aria-labelledby="email-sms-alarm-alert-tab" style="padding:15px; background:#ffff;">
            <div class="d-flex justify-content-end align-items-end"> 
                {% if data.role == 'Super Admin' or acc_db.e_set_e %} 
                <button class="btn btn-primary edit-button me-2" onclick="editMode1(this)">Edit</button>
                {% endif %}
                <button class="btn btn-success save-button d-none" onclick="saveMode1(this)">Save</button>
            </div>
            <div class="row mt-0 p-4" id="alertSections">
                <!-- Email Alert Section -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <input class="form-check-input" type="checkbox" id="activateEmail">
                        <label class="form-check-label" for="activateEmail">Activate Email Alert</label>
                    </div>
                    
                    <div class="checkbox-list-1">
                        {% for field in fields %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="{{ field.name }}" disabled {{ field.value|yesno:"checked," }}>
                                <label class="form-check-label" for="{{ field.name }}">{{ field.help_text }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
    
                <div class="col-md-6">
                    <div class="mb-3">
                        <input class="form-check-input" type="checkbox" id="activateSms">
                        <label class="form-check-label" for="activateSms">Activate SMS Alert</label>
                    </div>
                    <div class="checkbox-list-2">
                        {% for field in sms_fields %} 
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="{{ field.name }}" disabled {{ field.value|yesno:"checked," }}>
                            <label class="form-check-label" for="{{ field.name }}">{{ field.help_text }}</label>
                        </div>
                        {% endfor %}
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content container-custom">
            <div class="modal-header">
                <h4 class="modal-title" id="authModalLabel">Authentication Required</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="authForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="username" name="username" value="{{ data.username }}" readonly>
                            <label for="username" class="form-label">Username</label>
                        </div>
                        <div class="col-md-12 form-group">
                            <input type="password" class="form-control" id="password" required>
                            <label for="password" class="form-label">Password</label>
                        </div>
                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="Comments" required>
                            <label for="Comments" class="form-label">Comments</label>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success" id="confirmSave">Confirm</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function initTab(tab) {
                const formDataTable = tab.querySelector("tbody");
                const tableRows = Array.from(formDataTable.querySelectorAll("tr"));
    
                const visibleEntries = tab.querySelector("#visible-entries");
                const totalEntries = tab.querySelector("#total-entries");
                const pagination = tab.querySelector(".pagination");
                const selectAllCheckbox = tab.querySelector("#selectAll");
                const entriesPerPageSelect = tab.querySelector("#entriesPerPage");
                const prevPageButton = tab.querySelector("#prev-page");
                const nextPageButton = tab.querySelector("#next-page");
    
                let currentPage = 1;
                let entriesPerPage = parseInt(entriesPerPageSelect.value, 10);
                let filteredRows = tableRows;
    
                function updateTable() {
                    const startIndex = (currentPage - 1) * entriesPerPage;
                    const endIndex = startIndex + entriesPerPage;
    
                    tableRows.forEach(row => (row.style.display = "none"));
                    filteredRows.slice(startIndex, endIndex).forEach(row => (row.style.display = ""));
    
                    visibleEntries.textContent = filteredRows.slice(startIndex, endIndex).length;
                    totalEntries.textContent = filteredRows.length;
    
                    updatePagination();
                }
    
                function updatePagination() {
                    const pageItems = Array.from(pagination.querySelectorAll(".page-item:not(#prev-page):not(#next-page)"));
                    pageItems.forEach(item => item.remove());
    
                    const totalPages = Math.ceil(filteredRows.length / entriesPerPage);
    
                    prevPageButton.classList.toggle("disabled", currentPage === 1);
                    nextPageButton.classList.toggle("disabled", currentPage === totalPages);
    
                    for (let i = 1; i <= totalPages; i++) {
                        const pageItem = document.createElement("li");
                        pageItem.className = page-item ${i === currentPage ? "active" : ""};
                        pageItem.innerHTML = <a class="page-link" href="#">${i}</a>;
                        pageItem.addEventListener("click", event => {
                            event.preventDefault();
                            currentPage = i;
                            updateTable();
                        });
                        pagination.insertBefore(pageItem, nextPageButton);
                    }
                }
    
                selectAllCheckbox.addEventListener("change", function () {
                    const checkboxes = formDataTable.querySelectorAll("input[type='checkbox']:not(#selectAll)");
                    checkboxes.forEach(checkbox => (checkbox.checked = this.checked));
                });
    
                formDataTable.addEventListener("change", function (event) {
                    if (event.target.type === "checkbox" && event.target !== selectAllCheckbox) {
                        selectAllCheckbox.checked = Array.from(formDataTable.querySelectorAll("input[type='checkbox']:not(#selectAll)"))
                            .every(checkbox => checkbox.checked);
                    }
                });
    
                entriesPerPageSelect.addEventListener("change", function () {
                    entriesPerPage = parseInt(this.value, 10);
                    currentPage = 1; // Reset to first page
                    updateTable();
                });
    
                prevPageButton.addEventListener("click", function (event) {
                    event.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        updateTable();
                    }
                });
    
                nextPageButton.addEventListener("click", function (event) {
                    event.preventDefault();
                    const totalPages = Math.ceil(filteredRows.length / entriesPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateTable();
                    }
                });
    
                updateTable(); // Initialize table on load
            }
    
            function initializeAllTabs() {
                const tabs = document.querySelectorAll(".tab-pane");
                tabs.forEach(tab => {
                    if (!tab.hasAttribute("data-initialized")) {
                        tab.setAttribute("data-initialized", "true");
                        initTab(tab);
                    }
                });
            }
    
            // Initialize active tab on page load
            initializeAllTabs();
    
            // Reinitialize on tab change
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabTrigger => {
                tabTrigger.addEventListener("shown.bs.tab", function () {
                    initializeAllTabs();
                });
            });
        });
    </script>

<script>
    // Activate all email alert checkboxes
    document.getElementById('activateEmail').addEventListener('change', function() {
        let emailCheckboxes = document.querySelectorAll('.checkbox-list-1 .form-check-input');
        emailCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Activate all SMS alert checkboxes
    document.getElementById('activateSms').addEventListener('change', function() {
        let smsCheckboxes = document.querySelectorAll('.checkbox-list-2 .form-check-input');
        smsCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    function editMode(button) {
   
   const formContainer = button.closest('.tab-pane');
   formContainer.querySelectorAll('input, select').forEach(input => {
       input.removeAttribute('readonly');
       input.disabled = false;
   });
   button.classList.add('d-none'); 
   formContainer.querySelector('.save-button').classList.remove('d-none'); 
}

function saveMode(button) {
    // Get the parent tab-pane of the button
    const formContainer = button.closest('.tab-pane');

    // Ensure the modal is triggered only when the save button is clicked in the "settings" tab
    if (formContainer.id !== "settings") {
        saveparametersMode()
        return;
    }

    let inputData = {};
    inputData['tab_name'] = formContainer.getAttribute('id');
    inputData['equipment_ip'] = document.getElementById('ip_address').value;

    formContainer.querySelectorAll('input, select').forEach(input => {
        inputData[input.name] = input.value;
    });

    // Show the authentication modal
    const authModal = new bootstrap.Modal(document.getElementById('authModal'), {
        backdrop: 'true',
        keyboard: false
    });
    authModal.show();

    // Handle authentication form submission
    const authForm = document.getElementById('authForm');
    const confirmSaveButton = document.getElementById('confirmSave');

    confirmSaveButton.addEventListener('click', function (event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const acknowledge = document.getElementById('Comments').value;

        if (!password || !acknowledge) {
            alert('Please provide valid credentials.');
            return;
        }

        // Include authentication data in the inputData object
        inputData['username'] = username;
        inputData['password'] = password;
        inputData['acknowledge'] = acknowledge;

        fetch("{% url 'save_equipment_settings' %}", {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(inputData)
})
.then(response => {
    // First, check if the response is ok (status 200-299)
    if (!response.ok) {
        // If not ok, return the response as JSON with a rejection to enter the catch block
        return response.json().then(json => Promise.reject(json));
    }
    // If ok, parse the response as JSON
    return response.json();
})
.then(data => {
    // Process your successful response data here
    alert(data.message);  // Display success message from server
    authModal.hide();  // Assuming you have a modal to hide after processing
})
.catch(errorData => {
    // Error handling block
    console.error('Error:', errorData);
    alert(errorData.message);  // Use the errorData object, which should have the 'message' field
});

    });
}


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


// Reset only password and comment fields on modal close
    document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('password').value = ''; // Clear the password field
        document.getElementById('Comments').value = ''; // Clear the comment field
    });

    // Optional: Form submission logic
    document.getElementById('authForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission
        const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
        modal.hide(); // Close the modal after processing the form
    });


    // Code for Modal Popup for equipment settings

    document.addEventListener('DOMContentLoaded', function() {
    // Function to disable elements
    function toggleEditable(state) {
        const selects = document.querySelectorAll('.color-select');
        const checkboxes = document.querySelectorAll('.row-checkbox');
        selects.forEach(select => {
            select.disabled = !state;
        });
        checkboxes.forEach(checkbox => {
            checkbox.disabled = !state;
        });
    }

    // Initially disable the form elements
    toggleEditable(false);

    // Function to enable edit mode
    function editMode(button) {
        toggleEditable(true);
        button.classList.add('d-none'); // Hide the edit button
        const saveButton = button.nextElementSibling;
        saveButton.classList.remove('d-none'); // Show the save button
    }

    // Function to save changes and disable edit mode
    function saveMode(button) {
        toggleEditable(false);
        button.classList.add('d-none'); // Hide the save button
        const editButton = button.previousElementSibling;
        editButton.classList.remove('d-none'); // Show the edit button
    }

    // Event listeners for edit buttons
    const editButtons = document.querySelectorAll('.edit-button');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            editMode(this);
        });
    });

    // Event listeners for save buttons
    const saveButtons = document.querySelectorAll('.save-button');
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            saveMode(this);
        });
    });
});
  
function saveparametersMode(button) {
    const ip_address = document.getElementById('ip_address').value;

    // Gather all the data from the table
    const dataToSend = [];
    const rows = document.querySelectorAll('#form-data-table tr');
    rows.forEach(row => {
        const checkbox = row.querySelector('.row-checkbox');
        if (checkbox.checked) {
            const name = row.cells[1].textContent;
            const colorSelect = row.querySelector('.color-select');
            const color = colorSelect.value;
            dataToSend.push({ name, color });
        }
    });

    // Convert data to JSON
    const jsonData = JSON.stringify({
        parameters: dataToSend,
        ip_address: ip_address // IP address added once at the end
    });

    // Send data to the server
    fetch('/save-parameters/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken() // Function to get CSRF token
        },
        body: jsonData
    })
    .then(response => response.json())
    .then(data => {

        alert('Data saved successfully!');
    })
    .catch((error) => {

        alert('Error saving data');
    });

    // Disable edit mode
    toggleEditable(false);
    button.classList.add('d-none'); // Hide the save button
    const editButton = button.previousElementSibling;
    editButton.classList.remove('d-none'); // Show the edit button
}

// Helper function to get CSRF token from cookies
function getCsrfToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1];
}
  


function saveMode1(button) {
    let emailAlerts = [];
    let smsAlerts = [];

    const ip_address = document.getElementById('ip_address').value;  // Get IP address from input


    // Collect only checked checkboxes from email alerts
    document.querySelectorAll('.checkbox-list-1 .form-check-input:checked').forEach((checkbox) => {
        emailAlerts.push(checkbox.id.replace('emailAlert', ''));  // Collecting numeric part of ID
    });

    // Collect only checked checkboxes from SMS alerts
    document.querySelectorAll('.checkbox-list-2 .form-check-input:checked').forEach((checkbox) => {
        smsAlerts.push(checkbox.id.replace('smsAlert', ''));  // Collecting numeric part of ID
    });

    // Package each alert list with the IP address
    const data = {
        emailData: { email: emailAlerts },
        smsData: { sms: smsAlerts,  },
        ip_address: {ip_address:ip_address}
    };


    fetch('/save-alert-settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // Ensuring CSRF token is included for Django
        },
        body: JSON.stringify(data)
    }).then(response => response.json())
      .then(data => {
        alert("Alert settings saved successfully!");

      })
      .catch((error) => {
          console.error('Error:', error);
      });
}

// Function to get CSRF token from cookies (required for Django POST requests)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function editMode1(button) {
    // Enable all checkboxes in both email and SMS alert sections
    document.querySelectorAll('.checkbox-list-1 .form-check-input').forEach((checkbox) => {
        checkbox.disabled = false;  // Enable the checkbox
    });
    document.querySelectorAll('.checkbox-list-2 .form-check-input').forEach((checkbox) => {
        checkbox.disabled = false;  // Enable the checkbox
    });

    // Optionally hide the edit button and show the save button
    button.classList.add('d-none');  // Hide the edit button
    document.querySelector('.save-button').classList.remove('d-none');  // Show the save button
}

</script>
{% endblock %}
{% endblock content %}